jQuery(document).ready(function(a){"use strict";var i,r,n,o,s,c,l,d,f,t,u=collageAtts,y=["EN","DE","ZH","AR","FR","ES","RU"],p=["in English Wikipedia","in German Wikipedia","in Chinese Wikipedia","in Arabic Wikipedia","in French Wikipedia","in Spanish Wikipedia","in Russian Wikipedia"],h="#"+u.id,x=a(h),g=x.parent().siblings().first(),e=x.parent().find(".fake-scroll"),w=a("body"),m=a("html"),v=x.find("h1"),k=x.find("#intro-1"),b=x.find("#intro-2"),A=x.find(".recent-edits"),E=A.find(".label"),j=A.find(".title"),q=x.find(".story-overlay"),H=a("header").height(),S=m.width(),T=window.innerHeight,F="#202122",L="#36c",W=1200,C=[{x:.56,y:.62},{x:.7,y:.52},{x:.51,y:.68},{x:.73,y:.38},{x:.29,y:.57},{x:.41,y:.61},{x:.48,y:.31},{x:.71,y:.6},{x:.65,y:.29},{x:.35,y:.32},{x:.24,y:.41},{x:.31,y:.69},{x:.57,y:.24},{x:.43,y:.23},{x:.28,y:.27}],z=q.find(".story-content"),M=[],R=5,D=Math.max(y.length*R,80),G=z.length,I=5,O=2*I,B=3*O,N=.12,Q=.24,U=.5,Z=.9,J=d3.scaleLinear().domain([U,U+.1]).range([0,1]),K=d3.scaleLinear().domain([Z-.1,Z]).range([1,0]),P=0,V=[],X=0;for(console.log("collage",u);M.length<D;){var Y=_(0,1),$=_(0,1);.35<Y&&Y<.6&&.35<$&&$<.6||M.push({x:Y,y:$})}function _(t,e){return(Math.random()*(e-t)+t).toFixed(2)}function tt(t,e,i){var n="https://"+t.toLowerCase()+".wikipedia.org/w/api.php",r={action:"query",list:"recentchanges",rcnamespace:"0",rcprop:"title|flags|timestamp",rcstart:e,rcend:i,rctype:"edit",rcshow:"!bot",rclimit:R,format:"json"};return n+="?origin=*",Object.keys(r).forEach(function(t){n+="&"+t+"="+r[t]}),n}function et(t){if(document.hasFocus()||t){var e=new Date,i=e.toISOString(),n=new Date(e.getTime()-36e5),r=n.toISOString();console.log(r,"\n",i,"\n",n.toLocaleTimeString()+" to "+e.toLocaleTimeString()),V=[],a.when(a.ajax(tt(y[0],i,r)),a.ajax(tt(y[1],i,r)),a.ajax(tt(y[2],i,r)),a.ajax(tt(y[3],i,r)),a.ajax(tt(y[4],i,r)),a.ajax(tt(y[5],i,r)),a.ajax(tt(y[6],i,r))).always(function(t,e,i,n,r,a,o){"success"===t[1]&&t[0].query.recentchanges.forEach(function(t){t.wiki=p[0],V.push(t)}),"success"===e[1]&&e[0].query.recentchanges.forEach(function(t){t.wiki=p[1],V.push(t)}),"success"===i[1]&&i[0].query.recentchanges.forEach(function(t){t.wiki=p[2],V.push(t)}),"success"===n[1]&&n[0].query.recentchanges.forEach(function(t){t.wiki=p[3],V.push(t)}),"success"===r[1]&&r[0].query.recentchanges.forEach(function(t){t.wiki=p[4],V.push(t)}),"success"===a[1]&&a[0].query.recentchanges.forEach(function(t){t.wiki=p[5],V.push(t)}),"success"===o[1]&&o[0].query.recentchanges.forEach(function(t){t.wiki=p[6],V.push(t)}),d3.shuffle(V),ft()})}else ft()}function it(){var t=window.innerHeight-H,e=m.width();i.attr("height",t).attr("width",e).attr("viewBox","0 0 "+e+" "+t),n.range([O,t-O]),s.range([O,e-O]),o.selectAll("circle").style("opacity",0).attr("cx",function(t){return s(t.x)}).attr("cy",function(t){return n(t.y)}).transition().delay(function(t,e){return 10*e}).style("opacity",function(){return _(.1,.9)}),l.selectAll("circle").attr("class","story-blob").style("opacity",0).style("visibility","hidden").attr("cx",function(t){return s(t.x)}).attr("cy",function(t){return n(t.y)}).on("mouseover",function(){d3.select(this).transition().style("fill",L).attr("r",2*O)}).on("mouseleave",function(){d3.select(this).transition().style("fill",F).attr("r",O)}).on("click",rt),d.selectAll("line").attr("x1",function(t){return s(t.x)+I}).attr("x2",function(t){return s(t.x)+3*I}).attr("y1",function(t){return n(t.y)-2*I}).attr("y2",function(t){return n(t.y)-5*I}),d.selectAll("text").attr("x",function(t){return s(t.x)+3*I}).attr("y",function(t){return n(t.y)-5*I}).attr("dy","-5px"),q.find(".close").click(function(){w.css("overflow","hidden auto"),lt(q)}),f.attr("width",e),r.call(c.transform,d3.zoomIdentity,d3.zoomTransform(r.node()).invert([e/2,t/2])),w.css("overflow","hidden auto")}function nt(){z.hide(),a(z[X]).show(),0===X?(dt(x.find(".next-story")),lt(x.find(".prev-story"))):(X===G-1?lt(x.find(".next-story")):dt(x.find(".next-story")),dt(x.find(".prev-story")))}function rt(t,e){X=e,nt(),w.css("overflow","hidden"),dt(q),d.transition().style("opacity",0).style("visibility","hidden")}function at(){0<V.length&&(E.text(u.label+" "+V[P].wiki),j.text(V[P].title),dt(A),o.selectAll("circle").filter(function(t,e){return e===P}).transition().duration(500).style("fill",L).style("opacity",1).attr("r",O).transition().delay(1500).style("fill",F).style("opacity",_(.1,.9)).attr("r",I).on("end",function(){++P<V.length?at():(P=0,et())}))}function ot(){lt(A),o.selectAll("circle").filter(function(t,e){return e===P}).interrupt().style("fill",F).style("opacity",.5).attr("r",I)}function st(){l.selectAll("circle").style("opacity",0).style("visibility","hidden").attr("r",I),d.style("opacity",0).style("visibility","hidden"),o.style("opacity",1)}function ct(t,e,i){var n=function(t,e,i){return t<e+.1?J(t):i-.1<t?K(t):1}(t,e,i);l.selectAll("circle").style("opacity",n).style("visibility","visible").attr("r",O),d.style("opacity",n).style("visibility","visible"),o.style("opacity",Math.max(.1,1-n))}function lt(t){t.removeClass("visible").addClass("hidden")}function dt(t){t.removeClass("hidden").addClass("visible")}function ft(){x.show();var t=a(window).scrollTop(),e=1+t/W/2,i=((t-(g.offset().top-window.innerHeight))/window.innerHeight).toFixed(2),n=t/(g.offset().top-window.innerHeight);r.call(c.scaleTo,e),n<N?(dt(k),lt(b),lt(v),st(),ot(),lt(q)):n<Q?(lt(k),dt(b),lt(v),st(),ot(),lt(q)):n<U?(lt(k),lt(b),dt(v),st(),at(),lt(q)):n<Z?(lt(k),lt(b),dt(v),ct(n,U,Z),ot()):Z<=n&&(lt(k),lt(b),dt(v),st(),ot(),lt(q),x.css("opacity",Math.max(0,1-i)))}function ut(){var t=d3.event.transform;r.attr("transform","translate("+t.x+","+t.y+") scale("+t.k+")")}a(window).scroll(function(){a(window).scrollTop()>=g.offset().top?x.hide():requestAnimationFrame(ft)}),a(window).resize(function(){S===m.width()&&T===window.innerHeight||(S=m.width(),T=window.innerHeight,requestAnimationFrame(function(){it(),at(),ft()}))}),t=2*W,e.css("height",t/window.innerHeight*100+"vh"),g.css({position:"relative","background-color":"#ffffff","padding-top":"2.5rem","padding-bottom":"0.5rem"}),function(t){i=d3.select(h).append("svg"),r=i.append("g").attr("transform-origin","0 0 0"),n=d3.scaleLinear().domain([0,d3.max(M,function(t){return t.y})]),s=d3.scaleLinear().domain([0,1]),(o=r.append("g")).selectAll("circle").data(M).enter().append("circle").attr("class",function(t){return t.x+" "+t.y}).style("fill",F).attr("r",I);var e=i.append("defs").append("linearGradient").attr("id","mainGradient").attr("gradientTransform","rotate(90)");e.append("stop").attr("class","stop-0").attr("offset","0"),e.append("stop").attr("class","stop-1").attr("offset","1"),f=i.append("rect").classed("filled",!0).attr("x",0).attr("y",0).attr("width",S).attr("height",2*O),(d=r.append("g").attr("class","click-cue")).selectAll("line").data([C[8]]).enter().append("line"),d.selectAll("text").data([C[8]]).enter().append("text").text(u.click).attr("text-anchor","start"),d.style("opacity",0).style("visibility","hidden"),(l=r.append("g").attr("transform-origin","0 0 0")).selectAll("circle").data(C.slice(0,G)).enter().append("circle").attr("title",function(t,e){return"Story "+(e+1)}).style("fill",F).style("stroke-width",B).style("stroke","rgba(255, 255, 255, 0)").attr("r",I),x.find(".next-story").click(function(){X<G-1&&(X++,nt())}),x.find(".prev-story").click(function(){0<X&&(X--,nt())}),c=d3.zoom().scaleExtent([1,1.7]).duration(0).on("zoom",ut),t()}(ft),it(),et(!0)});