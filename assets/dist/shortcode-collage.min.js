jQuery(document).ready(function(a){"use strict";for(var n,r,s,l,o,c,d,y,f,u,p,t,i=collageAtts,h=["EN","DE","ZH","AR","FR","ES","RU"],x=["in English Wikipedia","in German Wikipedia","in Chinese Wikipedia","in Arabic Wikipedia","in French Wikipedia","in Spanish Wikipedia","in Russian Wikipedia"],g="#"+i.id,w=a(g),v=w.parent().siblings().first(),e=w.parent().find(".fake-scroll"),m=a("body"),b=a("html"),k=w.find("h1"),A=w.find("#intro-1"),C=w.find("#intro-2"),E=w.find(".recent-edits"),T=E.find(".label"),M=E.find(".title"),j=w.find(".story-overlay"),F=a("header"),q=b.width(),H=window.innerHeight,S="#202122",W="#36c",L=4e3,z=[{x:.56,y:.62},{x:.7,y:.52},{x:.51,y:.68},{x:.73,y:.38},{x:.28,y:.58},{x:.41,y:.59},{x:.48,y:.31},{x:.71,y:.6},{x:.65,y:.29},{x:.35,y:.33},{x:.24,y:.41},{x:.34,y:.69},{x:.57,y:.24},{x:.4,y:.23},{x:.28,y:.27},{x:.29,y:.48},{x:.66,y:.69},{x:.75,y:.46},{x:.74,y:.32},{x:.49,y:.2}],O=i.story_rgba.split("|"),R=8,D=!0,G=j.find(".story-content"),I=[],B=5,N=Math.max(h.length*B,70),Q=G.length,U=5,Z=2*U,_=3*Z,J=.1,K=.2,P=.4,V=.92,X=d3.scaleLinear().domain([P,P+.1]).range([0,1]),Y=d3.scaleLinear().domain([V-.1,V]).range([1,0]),$=1.55,tt=[{path:"M2.144 15.73C3.24 10.737 5.915-.236 13.021 5.197c3.698 2.829 6.35 11.588 12.43 8.287 3.736-2.029 9.713-14.497 14.674-10.704 3.657 2.797 7.793 11.583 13.638 9.495C56.88 11.164 65.928.963 68.955 3.99c6.312 6.311 7.397 9.127 15.883 2.417 8.494-6.717 7.235-2.077 13.638 3.97 2.544 2.403 9.622.091 10.876-2.416",x:.1,y:.15,r:90},{path:"M2.144 15.73C3.24 10.737 5.915-.236 13.021 5.197c3.698 2.829 6.35 11.588 12.43 8.287 3.736-2.029 9.713-14.497 14.674-10.704 3.657 2.797 7.793 11.583 13.638 9.495C56.88 11.164 65.928.963 68.955 3.99c6.312 6.311 7.397 9.127 15.883 2.417 8.494-6.717 7.235-2.077 13.638 3.97 2.544 2.403 9.622.091 10.876-2.416",x:.62,y:.66,r:90},{path:"M41.286 5.24C31.346-1.987 23.23 1.895 22.64 15.773c-.23 5.407.69 9.012 4.661 12.775 2.71 2.567 4.086-.46 2.762-3.108C28.99 23.29 18.014 18.493 10 21.5-.5 25.44.425 40.745 7.103 44.084",x:.79,y:.87,r:0},{path:"M41.286 5.24C31.346-1.987 23.23 1.895 22.64 15.773c-.23 5.407.69 9.012 4.661 12.775 2.71 2.567 4.086-.46 2.762-3.108C28.99 23.29 18.014 18.493 10 21.5-.5 25.44.425 40.745 7.103 44.084",x:.5,y:.05,r:85},{path:"M2 2c1.3 3.96 8.346 24.812 15.63 15.01 1.913-2.574 1.124-9.324-3.16-8.69-3.538.524-4.95 7.897-5.181 10.62-.542 6.372.877 13.801 5.356 18.61C23.46 47.013 42.616 42.798 51 35.18",x:.85,y:.1,r:0},{path:"M2 2c1.3 3.96 8.346 24.812 15.63 15.01 1.913-2.574 1.124-9.324-3.16-8.69-3.538.524-4.95 7.897-5.181 10.62-.542 6.372.877 13.801 5.356 18.61C23.46 47.013 42.616 42.798 51 35.18",x:.15,y:.85,r:-100}],et=0,it=[],nt=0;I.length<N;){var rt=st(0,1),at=st(0,1);.35<rt&&rt<.6&&.35<at&&at<.6||I.push({x:rt,y:at})}function st(t,e){return(Math.random()*(e-t)+t).toFixed(2)}function lt(t,e){var i=.5,n=.5,r=parseFloat(t.x),a=parseFloat(e.x),s=parseFloat(t.y),l=parseFloat(e.y);return(r-i)*(r-i)+(s-n)*(s-n)-((a-i)*(a-i)+(l-n)*(l-n))}function ot(t,e,i){var n="https://"+t.toLowerCase()+".wikipedia.org/w/api.php",r={action:"query",list:"recentchanges",rcnamespace:"0",rcprop:"title|flags|timestamp",rcstart:e,rcend:i,rctype:"edit",rcshow:"!bot",rclimit:B,format:"json"};return n+="?origin=*",Object.keys(r).forEach(function(t){n+="&"+t+"="+r[t]}),n}function ct(t){if(document.hasFocus()||t){var e=new Date,i=e.toISOString(),n=new Date(e.getTime()-36e5),r=n.toISOString();console.log(r,"\n",i,"\n",n.toLocaleTimeString()+" to "+e.toLocaleTimeString()),it=[],a.when(a.ajax(ot(h[0],i,r)),a.ajax(ot(h[1],i,r)),a.ajax(ot(h[2],i,r)),a.ajax(ot(h[3],i,r)),a.ajax(ot(h[4],i,r)),a.ajax(ot(h[5],i,r)),a.ajax(ot(h[6],i,r))).always(function(t,e,i,n,r,a,s){"success"===t[1]&&t[0].query.recentchanges.forEach(function(t){t.wiki=x[0],it.push(t)}),"success"===e[1]&&e[0].query.recentchanges.forEach(function(t){t.wiki=x[1],it.push(t)}),"success"===i[1]&&i[0].query.recentchanges.forEach(function(t){t.wiki=x[2],it.push(t)}),"success"===n[1]&&n[0].query.recentchanges.forEach(function(t){t.wiki=x[3],it.push(t)}),"success"===r[1]&&r[0].query.recentchanges.forEach(function(t){t.wiki=x[4],it.push(t)}),"success"===a[1]&&a[0].query.recentchanges.forEach(function(t){t.wiki=x[5],it.push(t)}),"success"===s[1]&&s[0].query.recentchanges.forEach(function(t){t.wiki=x[6],it.push(t)}),d3.shuffle(it),kt()})}else kt()}function dt(){var t=window.innerHeight-F.height(),e=b.width(),i=500<window.innerWidth?1:.7;n.attr("height",t).attr("width",e).attr("viewBox","0 0 "+e+" "+t),s.range([Z,t-Z]),o.range([Z,e-Z]),l.selectAll("circle").style("opacity",0).attr("cx",function(t){return o(t.x)}).attr("cy",function(t){return s(t.y)}).transition().delay(function(t,e){return 10*e}).style("opacity",function(){return st(.1,.9)}),d.selectAll("circle").attr("class","story-blob story-unread").style("opacity",0).style("visibility","hidden").attr("cx",function(t){return o(t.x)}).attr("cy",function(t){return s(t.y)}).on("mouseover",function(){var t=d3.select(this).attr("data-color");d3.select(this).transition().style("fill",t).attr("r",2*Z)}).on("mouseleave",function(){var t=-1<d3.select(this).attr("class").indexOf("story-read")?d3.select(this).attr("data-color"):S;d3.select(this).transition().style("fill",t).attr("r",Z)}).on("click",ut),y.selectAll("line").attr("x1",function(t){return o(t.x)+U}).attr("x2",function(t){return o(t.x)+3*U}).attr("y1",function(t){return s(t.y)-2*U}).attr("y2",function(t){return s(t.y)-5*U}),y.selectAll("text").attr("x",function(t){return o(t.x)+3*U}).attr("y",function(t){return s(t.y)-5*U}).attr("dy","-5px"),f.attr("transform","translate("+o(z[R].x)+", "+s(z[R].y)+")").style("opacity",1),j.find(".close").click(yt),m.keyup(function(t){"Escape"===t.key&&yt()}),u.attr("width",e),p.selectAll("path").attr("transform",function(t,e){return"translate("+o(tt[e].x)+", "+s(tt[e].y-.001)+") rotate("+tt[e].r+") scale("+i+")"}).attr("stroke-dasharray","500 500").attr("stroke-dashoffset",500).transition().duration(1400).attr("transform",function(t,e){return"translate("+o(tt[e].x)+", "+s(tt[e].y)+") rotate("+tt[e].r+") scale("+i+")"}).delay(function(t,e){return 10*N+200*e}).attr("stroke-dashoffset",0),r.call(c.transform,d3.zoomIdentity,d3.zoomTransform(r.node()).invert([e/2,t/2])),m.css("overflow","hidden auto")}function yt(){m.css("overflow","hidden auto"),mt(j),w.focus(),vt()}function ft(){G.hide(),a(G[nt]).show(),pt(nt),w.find(".story-nav .p").text(nt+1+"/"+Q),j.find(".story-content-container").scrollTop(0)}function ut(t,e){nt=e,ft(),m.css("overflow","hidden"),bt(j),pt(e),y.transition().style("opacity",0).style("visibility","hidden"),f.transition().style("opacity",0).style("visibility","hidden")}function pt(i){var t=d.selectAll("circle").filter(function(t,e){return e===i}),e=t.attr("data-color");t.style("fill",e).attr("class","story-blob story-read"),i===R&&(D=!1)}function ht(){0<it.length&&(T.text(i.label+" "+it[et].wiki),M.text(it[et].title),bt(E),l.selectAll("circle").sort(lt).filter(function(t,e){return e===et}).transition().duration(500).style("fill",W).style("opacity",1).attr("r",Z).transition().delay(1500).style("fill",S).style("opacity",st(.1,.9)).attr("r",U).on("end",function(){++et<it.length?ht():(et=0,ct())}))}function xt(){mt(E),l.selectAll("circle").filter(function(t,e){return e===et}).interrupt().style("fill",S).style("opacity",.5).attr("r",U)}function gt(){var t,e;return d3.select(".story-unread").each(function(){t=d3.select(this).attr("cx"),e=d3.select(this).attr("cy")}),[t,e]}function wt(){d.selectAll("circle").style("opacity",0).style("visibility","hidden").attr("r",U),y.style("opacity",0).style("visibility","hidden"),f.style("opacity",0).style("visibility","hidden"),l.style("opacity",1)}function vt(t,e,i){var n=function(t,e,i){return t<e+.1?X(t):i-.1<t?Y(t):1}(t,e,i);d.selectAll("circle").style("opacity",n).style("visibility","visible").attr("r",Z),D?(y.style("opacity",n).style("filter","blur("+2*(1-n)+"px)").style("visibility","visible"),f.style("opacity",n).style("visibility","visible")):f.style("opacity",n).style("visibility","visible").attr("transform","translate("+gt()[0]+", "+gt()[1]+")"),l.style("opacity",Math.max(.1,1-n))}function mt(t){t.removeClass("visible").addClass("hidden")}function bt(t){t.removeClass("hidden").addClass("visible")}function kt(){w.show();var t=a(window).scrollTop(),e=Math.min(1+t/L/2,$),i=((t-(v.offset().top-window.innerHeight))/window.innerHeight).toFixed(2),n=t/(v.offset().top-window.innerHeight);n<J?(r.call(c.scaleTo,e),bt(A),mt(C),mt(k),wt(),p.style("visibility","visible"),xt()):n<K?(r.call(c.scaleTo,e),mt(A),bt(C),mt(k),wt(),p.style("visibility","visible"),xt()):n<P?(r.call(c.scaleTo,e),mt(A),mt(C),bt(k),wt(),p.style("visibility","hidden"),ht()):n<V?(r.call(c.scaleTo,e),mt(A),mt(C),bt(k),vt(n,P,V),p.style("visibility","hidden"),xt()):V<=n&&(r.call(c.scaleTo,e-Math.max(0,n-V)),mt(A),mt(C),bt(k),wt(),p.style("visibility","hidden"),xt(),w.css("opacity",Math.max(0,1-i)))}function At(){var t=d3.event.transform;r.attr("transform","translate("+t.x+","+t.y+") scale("+t.k+")")}a(window).scroll(function(){a(window).scrollTop()>=v.offset().top?w.hide():requestAnimationFrame(kt)}),a(window).resize(function(){q===b.width()&&H===window.innerHeight||(q=b.width(),H=window.innerHeight,requestAnimationFrame(function(){dt(),ht(),kt()}))}),t=2*L,e.css("height",t/window.innerHeight*100+"vh"),v.css({position:"relative","background-color":"#ffffff","padding-top":"2.5rem","padding-bottom":"0.5rem"}),function(t){a(".header-main").hide(),n=d3.select(g).append("svg"),r=n.append("g").attr("transform-origin","0 0 0"),s=d3.scaleLinear().domain([0,d3.max(I,function(t){return t.y})]),o=d3.scaleLinear().domain([0,1]),(l=r.append("g").attr("class","blobs-g")).selectAll("circle").data(I).enter().append("circle").attr("class",function(t){return t.x+" "+t.y}).style("fill",S).attr("r",U);var e=n.append("defs").append("linearGradient").attr("id","mainGradient").attr("gradientTransform","rotate(90)");e.append("stop").attr("class","stop-0").attr("offset","0"),e.append("stop").attr("class","stop-1").attr("offset","1"),u=n.append("rect").classed("filled",!0).attr("x",0).attr("y",0).attr("width",q).attr("height",2*Z),(y=r.append("g").attr("class","click-cue")).selectAll("line").data([z[R]]).enter().append("line"),y.selectAll("text").data([z[R]]).enter().append("text").text(i.click).attr("text-anchor","start"),y.style("opacity",0).style("visibility","hidden"),(f=r.append("g").attr("class","pulse-g").style("opacity",0)).append("circle").attr("class","pulse").attr("cx","0%").attr("cy","0%").attr("r",Z).style("stroke",S),(d=r.append("g").attr("class","story-blobs")).selectAll("circle").data(z.slice(0,Q)).enter().append("circle").attr("title",function(t,e){return"Story "+(e+1)}).attr("data-color",function(t,e){return O[e]?"rgba"+O[e]:S}).style("fill",S).style("stroke-width",_).style("stroke","rgba(255, 255, 255, 0)").attr("r",U),G.each(function(t){a(this).find(".story-image").css("border","4px solid rgba"+O[t])}),(p=r.append("g").attr("class","ornaments-g")).selectAll("path").data(tt).enter().append("path").attr("class","ornament").attr("d",function(t){return t.path}).style("stroke-width",3).style("stroke",S).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round"),w.find(".next-story").click(function(){nt<Q-1?nt++:nt=0,ft()}),w.find(".prev-story").click(function(){0<nt?nt--:nt=Q-1,ft()}),c=d3.zoom().scaleExtent([1,2]).duration(0).on("zoom",At),t()}(kt),dt(),ct(!0)});