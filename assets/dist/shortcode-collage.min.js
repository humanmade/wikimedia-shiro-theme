jQuery(document).ready(function(r){"use strict";var n,a,i,c,o,s,l,d,f,t,u=collageAtts,y=["EN","DE","ZH","AR","FR","ES","RU"],p=["in English Wikipedia","in German Wikipedia","in Chinese Wikipedia","in Arabic Wikipedia","in French Wikipedia","in Spanish Wikipedia","in Russian Wikipedia"],h="#"+u.id,m=r(h),x=m.parent().siblings().first(),e=m.parent().find(".fake-scroll"),g=m.find("h1"),w=m.find(".intro"),v=m.find(".recent-edits"),k=v.find(".label"),b=v.find(".title"),A=m.find(".story-overlay"),N=r("header").height(),E=window.innerWidth,W="#202122",j="#36c",q=1200,S=[{x:.56,y:.62,name:"Name 1"},{x:.7,y:.52,name:"Name 2"},{x:.51,y:.68,name:"Name 3"},{x:.73,y:.38,name:"Name 4"},{x:.29,y:.57,name:"Name 5"},{x:.41,y:.61,name:"Name 6"},{x:.48,y:.27,name:"Name 7"},{x:.71,y:.6,name:"Name 8"},{x:.65,y:.29,name:"Name 9"},{x:.35,y:.32,name:"Name 10"},{x:.24,y:.41,name:"Name 11"},{x:.31,y:.69,name:"Name 12"},{x:.57,y:.24,name:"Name 13"},{x:.43,y:.2,name:"Name 14"},{x:.3,y:.25,name:"Name 15"}],T=[],F=5,L=Math.max(y.length*F,80),C=5,H=2*C,z=3*H,M=.12,R=.5,D=.9,G=d3.scaleLinear().domain([R,R+.1]).range([0,1]),I=d3.scaleLinear().domain([D-.1,D]).range([1,0]),O=0,B=[];for(console.log("collage",u);T.length<L;){var Q=Z(0,1),U=Z(0,1);.35<Q&&Q<.6&&.35<U&&U<.6||T.push({x:Q,y:U})}function Z(t,e){return(Math.random()*(e-t)+t).toFixed(2)}function J(t,e,n){var i="https://"+t.toLowerCase()+".wikipedia.org/w/api.php",a={action:"query",list:"recentchanges",rcnamespace:"0",rcprop:"title|flags|timestamp",rcstart:e,rcend:n,rctype:"edit",rcshow:"!bot",rclimit:F,format:"json"};return i+="?origin=*",Object.keys(a).forEach(function(t){i+="&"+t+"="+a[t]}),i}function K(t){if(document.hasFocus()||t){var e=new Date,n=e.toISOString(),i=new Date(e.getTime()-36e5),a=i.toISOString();console.log(a,"\n",n,"\n",i.toLocaleTimeString()+" to "+e.toLocaleTimeString()),B=[],r.when(r.ajax(J(y[0],n,a)),r.ajax(J(y[1],n,a)),r.ajax(J(y[2],n,a)),r.ajax(J(y[3],n,a)),r.ajax(J(y[4],n,a)),r.ajax(J(y[5],n,a)),r.ajax(J(y[6],n,a))).always(function(t,e,n,i,a,r,c){"success"===t[1]&&t[0].query.recentchanges.forEach(function(t){t.wiki=p[0],B.push(t)}),"success"===e[1]&&e[0].query.recentchanges.forEach(function(t){t.wiki=p[1],B.push(t)}),"success"===n[1]&&n[0].query.recentchanges.forEach(function(t){t.wiki=p[2],B.push(t)}),"success"===i[1]&&i[0].query.recentchanges.forEach(function(t){t.wiki=p[3],B.push(t)}),"success"===a[1]&&a[0].query.recentchanges.forEach(function(t){t.wiki=p[4],B.push(t)}),"success"===r[1]&&r[0].query.recentchanges.forEach(function(t){t.wiki=p[5],B.push(t)}),"success"===c[1]&&c[0].query.recentchanges.forEach(function(t){t.wiki=p[6],B.push(t)}),d3.shuffle(B),nt()})}else nt()}function P(){var t=window.innerHeight-N,e=window.innerWidth;n.attr("height",t).attr("width",e).attr("viewBox","0 0 "+e+" "+t),i.range([H,t-H]),o.range([H,e-H]),c.selectAll("circle").style("opacity",0).attr("cx",function(t){return o(t.x)}).attr("cy",function(t){return i(t.y)}).transition().delay(function(t,e){return 10*e}).style("opacity",function(){return Z(.1,.9)}),l.selectAll("circle").attr("class","story-blob").style("opacity",0).style("visibility","hidden").attr("cx",function(t){return o(t.x)}).attr("cy",function(t){return i(t.y)}).on("mouseover",function(){d3.select(this).transition().style("fill",j).attr("r",2*H)}).on("mouseleave",function(){d3.select(this).transition().style("fill",W).attr("r",H)}).on("click",V),d.selectAll("line").attr("x1",function(t){return o(t.x)+C}).attr("x2",function(t){return o(t.x)+3*C}).attr("y1",function(t){return i(t.y)-2*C}).attr("y2",function(t){return i(t.y)-5*C}),d.selectAll("text").attr("x",function(t){return o(t.x)+3*C}).attr("y",function(t){return i(t.y)-5*C}).attr("dy","-5px"),A.find(".close").click(function(){tt(A)}),f.attr("width",e),a.call(s.transform,d3.zoomIdentity,d3.zoomTransform(a.node()).invert([e/2,t/2]))}function V(){A.find("h2").text(d3.select(this).data()[0].name),A.find(".image").css({top:Z(15,25)+"%"}),et(A),d.transition().style("opacity",0)}function X(){0<B.length&&(k.text(u.label+" "+B[O].wiki),b.text(B[O].title),et(v),c.selectAll("circle").filter(function(t,e){return e===O}).transition().duration(500).style("fill",j).style("opacity",1).attr("r",H).transition().delay(1500).style("fill",W).style("opacity",Z(.1,.9)).attr("r",C).on("end",function(){++O<B.length?X():(O=0,K())}))}function Y(){tt(v),c.selectAll("circle").filter(function(t,e){return e===O}).interrupt().style("fill",W).style("opacity",.5).attr("r",C)}function $(){l.selectAll("circle").style("opacity",0).style("visibility","hidden").attr("r",C),d.style("opacity",0).style("visibility","hidden"),c.style("opacity",1)}function _(t,e,n){var i=function(t,e,n){return t<e+.1?G(t):n-.1<t?I(t):1}(t,e,n);l.selectAll("circle").style("opacity",i).style("visibility","visible").attr("r",H),d.style("opacity",i).style("visibility","visible"),c.style("opacity",Math.max(.1,1-i))}function tt(t){t.removeClass("visible").addClass("hidden")}function et(t){t.removeClass("hidden").addClass("visible")}function nt(){m.show();var t=r(window).scrollTop(),e=1+t/q/2,n=((t-(x.offset().top-window.innerHeight))/window.innerHeight).toFixed(2),i=t/(x.offset().top-window.innerHeight);a.call(s.scaleTo,e),i<M?(et(w),tt(g),$(),Y(),tt(A)):i<R?(tt(w),et(g),$(),X(),tt(A)):i<D?(tt(w),et(g),_(i,R,D),Y()):D<=i&&(tt(w),et(g),$(),Y(),tt(A),m.css("opacity",Math.max(0,1-n)))}function it(){var t=d3.event.transform;a.attr("transform","translate("+t.x+","+t.y+") scale("+t.k+")")}r(window).scroll(function(){r(window).scrollTop()>=x.offset().top?m.hide():requestAnimationFrame(nt)}),r(window).resize(function(){E!==window.innerWidth&&(E=window.innerWidth,requestAnimationFrame(function(){P(),X(),nt()}))}),t=2*q,e.css("height",t/window.innerHeight*100+"vh"),x.css({position:"relative","background-color":"#ffffff","padding-top":"2.5rem","padding-bottom":"0.5rem"}),function(t){n=d3.select(h).append("svg"),a=n.append("g").attr("transform-origin","0 0 0"),i=d3.scaleLinear().domain([0,d3.max(T,function(t){return t.y})]),o=d3.scaleLinear().domain([0,1]),(c=a.append("g")).selectAll("circle").data(T).enter().append("circle").attr("class",function(t){return t.x+" "+t.y}).style("fill",W).attr("r",C),(d=a.append("g").attr("class","click-cue")).selectAll("line").data([S[8]]).enter().append("line"),d.selectAll("text").data([S[8]]).enter().append("text").text(u.click).attr("text-anchor","start"),d.style("opacity",0),(l=a.append("g").attr("transform-origin","0 0 0")).selectAll("circle").data(S.slice(0,15)).enter().append("circle").attr("title",function(t,e){return"Story "+(e+1)}).style("fill",W).style("stroke-width",z).style("stroke","rgba(255, 255, 255, 0)").attr("r",C);var e=n.append("defs").append("linearGradient").attr("id","mainGradient").attr("gradientTransform","rotate(90)");e.append("stop").attr("class","stop-0").attr("offset","0"),e.append("stop").attr("class","stop-1").attr("offset","1"),f=n.append("rect").classed("filled",!0).attr("x",0).attr("y",0).attr("width",E).attr("height",2*H),s=d3.zoom().scaleExtent([1,1.7]).duration(0).on("zoom",it),t()}(nt),P(),K(!0)});