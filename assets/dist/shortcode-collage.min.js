jQuery(document).ready(function(a){"use strict";var i,r,n,o,c,s,l,d,f,t,u=collageAtts,y=["EN","DE","ZH","AR","FR","ES","RU"],h=["in English Wikipedia","in German Wikipedia","in Chinese Wikipedia","in Arabic Wikipedia","in French Wikipedia","in Spanish Wikipedia","in Russian Wikipedia"],p="#"+u.id,g=a(p),w=g.parent().siblings().first(),e=g.parent().find(".fake-scroll"),x=a("body"),m=a("html"),v=g.find("h1"),k=g.find(".intro"),b=g.find(".recent-edits"),A=b.find(".label"),E=b.find(".title"),j=g.find(".story-overlay"),q=a("header").height(),H=m.width(),S=window.innerHeight,T="#202122",F="#36c",L=1200,W=[{x:.56,y:.62},{x:.7,y:.52},{x:.51,y:.68},{x:.73,y:.38},{x:.29,y:.57},{x:.41,y:.61},{x:.48,y:.31},{x:.71,y:.6},{x:.65,y:.29},{x:.35,y:.32},{x:.24,y:.41},{x:.31,y:.69},{x:.57,y:.24},{x:.43,y:.23},{x:.28,y:.27}],C=j.find(".story-content"),z=[],M=5,R=Math.max(y.length*M,80),D=C.length,G=5,I=2*G,O=3*I,B=.12,N=.5,Q=.9,U=d3.scaleLinear().domain([N,N+.1]).range([0,1]),Z=d3.scaleLinear().domain([Q-.1,Q]).range([1,0]),J=0,K=[],P=0;for(console.log("collage",u);z.length<R;){var V=Y(0,1),X=Y(0,1);.35<V&&V<.6&&.35<X&&X<.6||z.push({x:V,y:X})}function Y(t,e){return(Math.random()*(e-t)+t).toFixed(2)}function $(t,e,i){var n="https://"+t.toLowerCase()+".wikipedia.org/w/api.php",r={action:"query",list:"recentchanges",rcnamespace:"0",rcprop:"title|flags|timestamp",rcstart:e,rcend:i,rctype:"edit",rcshow:"!bot",rclimit:M,format:"json"};return n+="?origin=*",Object.keys(r).forEach(function(t){n+="&"+t+"="+r[t]}),n}function _(t){if(document.hasFocus()||t){var e=new Date,i=e.toISOString(),n=new Date(e.getTime()-36e5),r=n.toISOString();console.log(r,"\n",i,"\n",n.toLocaleTimeString()+" to "+e.toLocaleTimeString()),K=[],a.when(a.ajax($(y[0],i,r)),a.ajax($(y[1],i,r)),a.ajax($(y[2],i,r)),a.ajax($(y[3],i,r)),a.ajax($(y[4],i,r)),a.ajax($(y[5],i,r)),a.ajax($(y[6],i,r))).always(function(t,e,i,n,r,a,o){"success"===t[1]&&t[0].query.recentchanges.forEach(function(t){t.wiki=h[0],K.push(t)}),"success"===e[1]&&e[0].query.recentchanges.forEach(function(t){t.wiki=h[1],K.push(t)}),"success"===i[1]&&i[0].query.recentchanges.forEach(function(t){t.wiki=h[2],K.push(t)}),"success"===n[1]&&n[0].query.recentchanges.forEach(function(t){t.wiki=h[3],K.push(t)}),"success"===r[1]&&r[0].query.recentchanges.forEach(function(t){t.wiki=h[4],K.push(t)}),"success"===a[1]&&a[0].query.recentchanges.forEach(function(t){t.wiki=h[5],K.push(t)}),"success"===o[1]&&o[0].query.recentchanges.forEach(function(t){t.wiki=h[6],K.push(t)}),d3.shuffle(K),lt()})}else lt()}function tt(){var t=window.innerHeight-q,e=m.width();i.attr("height",t).attr("width",e).attr("viewBox","0 0 "+e+" "+t),n.range([I,t-I]),c.range([I,e-I]),o.selectAll("circle").style("opacity",0).attr("cx",function(t){return c(t.x)}).attr("cy",function(t){return n(t.y)}).transition().delay(function(t,e){return 10*e}).style("opacity",function(){return Y(.1,.9)}),l.selectAll("circle").attr("class","story-blob").style("opacity",0).style("visibility","hidden").attr("cx",function(t){return c(t.x)}).attr("cy",function(t){return n(t.y)}).on("mouseover",function(){d3.select(this).transition().style("fill",F).attr("r",2*I)}).on("mouseleave",function(){d3.select(this).transition().style("fill",T).attr("r",I)}).on("click",it),d.selectAll("line").attr("x1",function(t){return c(t.x)+G}).attr("x2",function(t){return c(t.x)+3*G}).attr("y1",function(t){return n(t.y)-2*G}).attr("y2",function(t){return n(t.y)-5*G}),d.selectAll("text").attr("x",function(t){return c(t.x)+3*G}).attr("y",function(t){return n(t.y)-5*G}).attr("dy","-5px"),j.find(".close").click(function(){x.css("overflow","hidden auto"),ct(j)}),f.attr("width",e),r.call(s.transform,d3.zoomIdentity,d3.zoomTransform(r.node()).invert([e/2,t/2])),x.css("overflow","hidden auto")}function et(){C.hide(),a(C[P]).show()}function it(t,e){P=e,et(),x.css("overflow","hidden"),st(j),d.transition().style("opacity",0).style("visibility","hidden")}function nt(){0<K.length&&(A.text(u.label+" "+K[J].wiki),E.text(K[J].title),st(b),o.selectAll("circle").filter(function(t,e){return e===J}).transition().duration(500).style("fill",F).style("opacity",1).attr("r",I).transition().delay(1500).style("fill",T).style("opacity",Y(.1,.9)).attr("r",G).on("end",function(){++J<K.length?nt():(J=0,_())}))}function rt(){ct(b),o.selectAll("circle").filter(function(t,e){return e===J}).interrupt().style("fill",T).style("opacity",.5).attr("r",G)}function at(){l.selectAll("circle").style("opacity",0).style("visibility","hidden").attr("r",G),d.style("opacity",0).style("visibility","hidden"),o.style("opacity",1)}function ot(t,e,i){var n=function(t,e,i){return t<e+.1?U(t):i-.1<t?Z(t):1}(t,e,i);l.selectAll("circle").style("opacity",n).style("visibility","visible").attr("r",I),d.style("opacity",n).style("visibility","visible"),o.style("opacity",Math.max(.1,1-n))}function ct(t){t.removeClass("visible").addClass("hidden")}function st(t){t.removeClass("hidden").addClass("visible")}function lt(){g.show();var t=a(window).scrollTop(),e=1+t/L/2,i=((t-(w.offset().top-window.innerHeight))/window.innerHeight).toFixed(2),n=t/(w.offset().top-window.innerHeight);r.call(s.scaleTo,e),n<B?(st(k),ct(v),at(),rt(),ct(j)):n<N?(ct(k),st(v),at(),nt(),ct(j)):n<Q?(ct(k),st(v),ot(n,N,Q),rt()):Q<=n&&(ct(k),st(v),at(),rt(),ct(j),g.css("opacity",Math.max(0,1-i)))}function dt(){var t=d3.event.transform;r.attr("transform","translate("+t.x+","+t.y+") scale("+t.k+")")}a(window).scroll(function(){a(window).scrollTop()>=w.offset().top?g.hide():requestAnimationFrame(lt)}),a(window).resize(function(){H===m.width()&&S===window.innerHeight||(H=m.width(),S=window.innerHeight,requestAnimationFrame(function(){tt(),nt(),lt()}))}),t=2*L,e.css("height",t/window.innerHeight*100+"vh"),w.css({position:"relative","background-color":"#ffffff","padding-top":"2.5rem","padding-bottom":"0.5rem"}),function(t){i=d3.select(p).append("svg"),r=i.append("g").attr("transform-origin","0 0 0"),n=d3.scaleLinear().domain([0,d3.max(z,function(t){return t.y})]),c=d3.scaleLinear().domain([0,1]),(o=r.append("g")).selectAll("circle").data(z).enter().append("circle").attr("class",function(t){return t.x+" "+t.y}).style("fill",T).attr("r",G);var e=i.append("defs").append("linearGradient").attr("id","mainGradient").attr("gradientTransform","rotate(90)");e.append("stop").attr("class","stop-0").attr("offset","0"),e.append("stop").attr("class","stop-1").attr("offset","1"),f=i.append("rect").classed("filled",!0).attr("x",0).attr("y",0).attr("width",H).attr("height",2*I),(d=r.append("g").attr("class","click-cue")).selectAll("line").data([W[8]]).enter().append("line"),d.selectAll("text").data([W[8]]).enter().append("text").text(u.click).attr("text-anchor","start"),d.style("opacity",0).style("visibility","hidden"),(l=r.append("g").attr("transform-origin","0 0 0")).selectAll("circle").data(W.slice(0,D)).enter().append("circle").attr("title",function(t,e){return"Story "+(e+1)}).style("fill",T).style("stroke-width",O).style("stroke","rgba(255, 255, 255, 0)").attr("r",G),a(".next-story").click(function(){P<D-1?P++:P=0,et()}),s=d3.zoom().scaleExtent([1,1.7]).duration(0).on("zoom",dt),t()}(lt),tt(),_(!0)});