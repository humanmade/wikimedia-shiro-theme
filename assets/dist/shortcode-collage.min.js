jQuery(document).ready(function(a){"use strict";var i,r,n,c,o,s,l,d,f,t,u=collageAtts,y=["EN","DE","ZH","AR","FR","ES","RU"],p=["in English Wikipedia","in German Wikipedia","in Chinese Wikipedia","in Arabic Wikipedia","in French Wikipedia","in Spanish Wikipedia","in Russian Wikipedia"],h="#"+u.id,x=a(h),g=x.parent().siblings().first(),e=x.parent().find(".fake-scroll"),w=a("body"),m=a("html"),v=x.find("h1"),k=x.find(".intro"),b=x.find(".recent-edits"),A=b.find(".label"),E=b.find(".title"),j=x.find(".story-overlay"),q=a("header").height(),S=m.width(),T="#202122",F="#36c",L=1200,W=[{x:.56,y:.62},{x:.7,y:.52},{x:.51,y:.68},{x:.73,y:.38},{x:.29,y:.57},{x:.41,y:.61},{x:.48,y:.27},{x:.71,y:.6},{x:.65,y:.29},{x:.35,y:.32},{x:.24,y:.41},{x:.31,y:.69},{x:.57,y:.24},{x:.43,y:.2},{x:.3,y:.25}],C=j.find(".story-content"),H=[],z=5,M=Math.max(y.length*z,80),R=C.length,D=5,G=2*D,I=3*G,O=.12,B=.5,N=.9,Q=d3.scaleLinear().domain([B,B+.1]).range([0,1]),U=d3.scaleLinear().domain([N-.1,N]).range([1,0]),Z=0,J=[],K=0;for(console.log("collage",u);H.length<M;){var P=X(0,1),V=X(0,1);.35<P&&P<.6&&.35<V&&V<.6||H.push({x:P,y:V})}function X(t,e){return(Math.random()*(e-t)+t).toFixed(2)}function Y(t,e,i){var n="https://"+t.toLowerCase()+".wikipedia.org/w/api.php",r={action:"query",list:"recentchanges",rcnamespace:"0",rcprop:"title|flags|timestamp",rcstart:e,rcend:i,rctype:"edit",rcshow:"!bot",rclimit:z,format:"json"};return n+="?origin=*",Object.keys(r).forEach(function(t){n+="&"+t+"="+r[t]}),n}function $(t){if(document.hasFocus()||t){var e=new Date,i=e.toISOString(),n=new Date(e.getTime()-36e5),r=n.toISOString();console.log(r,"\n",i,"\n",n.toLocaleTimeString()+" to "+e.toLocaleTimeString()),J=[],a.when(a.ajax(Y(y[0],i,r)),a.ajax(Y(y[1],i,r)),a.ajax(Y(y[2],i,r)),a.ajax(Y(y[3],i,r)),a.ajax(Y(y[4],i,r)),a.ajax(Y(y[5],i,r)),a.ajax(Y(y[6],i,r))).always(function(t,e,i,n,r,a,c){"success"===t[1]&&t[0].query.recentchanges.forEach(function(t){t.wiki=p[0],J.push(t)}),"success"===e[1]&&e[0].query.recentchanges.forEach(function(t){t.wiki=p[1],J.push(t)}),"success"===i[1]&&i[0].query.recentchanges.forEach(function(t){t.wiki=p[2],J.push(t)}),"success"===n[1]&&n[0].query.recentchanges.forEach(function(t){t.wiki=p[3],J.push(t)}),"success"===r[1]&&r[0].query.recentchanges.forEach(function(t){t.wiki=p[4],J.push(t)}),"success"===a[1]&&a[0].query.recentchanges.forEach(function(t){t.wiki=p[5],J.push(t)}),"success"===c[1]&&c[0].query.recentchanges.forEach(function(t){t.wiki=p[6],J.push(t)}),d3.shuffle(J),st()})}else st()}function _(){var t=window.innerHeight-q,e=m.width();i.attr("height",t).attr("width",e).attr("viewBox","0 0 "+e+" "+t),n.range([G,t-G]),o.range([G,e-G]),c.selectAll("circle").style("opacity",0).attr("cx",function(t){return o(t.x)}).attr("cy",function(t){return n(t.y)}).transition().delay(function(t,e){return 10*e}).style("opacity",function(){return X(.1,.9)}),l.selectAll("circle").attr("class","story-blob").style("opacity",0).style("visibility","hidden").attr("cx",function(t){return o(t.x)}).attr("cy",function(t){return n(t.y)}).on("mouseover",function(){d3.select(this).transition().style("fill",F).attr("r",2*G)}).on("mouseleave",function(){d3.select(this).transition().style("fill",T).attr("r",G)}).on("click",et),d.selectAll("line").attr("x1",function(t){return o(t.x)+D}).attr("x2",function(t){return o(t.x)+3*D}).attr("y1",function(t){return n(t.y)-2*D}).attr("y2",function(t){return n(t.y)-5*D}),d.selectAll("text").attr("x",function(t){return o(t.x)+3*D}).attr("y",function(t){return n(t.y)-5*D}).attr("dy","-5px"),j.find(".close").click(function(){w.css("overflow","hidden auto"),ct(j)}),f.attr("width",e),r.call(s.transform,d3.zoomIdentity,d3.zoomTransform(r.node()).invert([e/2,t/2])),w.css("overflow","hidden auto")}function tt(){C.hide(),a(C[K]).show()}function et(t,e){K=e,tt(),w.css("overflow","hidden"),ot(j),d.transition().style("opacity",0).style("visibility","hidden")}function it(){0<J.length&&(A.text(u.label+" "+J[Z].wiki),E.text(J[Z].title),ot(b),c.selectAll("circle").filter(function(t,e){return e===Z}).transition().duration(500).style("fill",F).style("opacity",1).attr("r",G).transition().delay(1500).style("fill",T).style("opacity",X(.1,.9)).attr("r",D).on("end",function(){++Z<J.length?it():(Z=0,$())}))}function nt(){ct(b),c.selectAll("circle").filter(function(t,e){return e===Z}).interrupt().style("fill",T).style("opacity",.5).attr("r",D)}function rt(){l.selectAll("circle").style("opacity",0).style("visibility","hidden").attr("r",D),d.style("opacity",0).style("visibility","hidden"),c.style("opacity",1)}function at(t,e,i){var n=function(t,e,i){return t<e+.1?Q(t):i-.1<t?U(t):1}(t,e,i);l.selectAll("circle").style("opacity",n).style("visibility","visible").attr("r",G),d.style("opacity",n).style("visibility","visible"),c.style("opacity",Math.max(.1,1-n))}function ct(t){t.removeClass("visible").addClass("hidden")}function ot(t){t.removeClass("hidden").addClass("visible")}function st(){x.show();var t=a(window).scrollTop(),e=1+t/L/2,i=((t-(g.offset().top-window.innerHeight))/window.innerHeight).toFixed(2),n=t/(g.offset().top-window.innerHeight);r.call(s.scaleTo,e),n<O?(ot(k),ct(v),rt(),nt(),ct(j)):n<B?(ct(k),ot(v),rt(),it(),ct(j)):n<N?(ct(k),ot(v),at(n,B,N),nt()):N<=n&&(ct(k),ot(v),rt(),nt(),ct(j),x.css("opacity",Math.max(0,1-i)))}function lt(){var t=d3.event.transform;r.attr("transform","translate("+t.x+","+t.y+") scale("+t.k+")")}a(window).scroll(function(){a(window).scrollTop()>=g.offset().top?x.hide():requestAnimationFrame(st)}),a(window).resize(function(){S!==m.width()&&(S=m.width(),requestAnimationFrame(function(){_(),it(),st()}))}),t=2*L,e.css("height",t/window.innerHeight*100+"vh"),g.css({position:"relative","background-color":"#ffffff","padding-top":"2.5rem","padding-bottom":"0.5rem"}),function(t){i=d3.select(h).append("svg"),r=i.append("g").attr("transform-origin","0 0 0"),n=d3.scaleLinear().domain([0,d3.max(H,function(t){return t.y})]),o=d3.scaleLinear().domain([0,1]),(c=r.append("g")).selectAll("circle").data(H).enter().append("circle").attr("class",function(t){return t.x+" "+t.y}).style("fill",T).attr("r",D);var e=i.append("defs").append("linearGradient").attr("id","mainGradient").attr("gradientTransform","rotate(90)");e.append("stop").attr("class","stop-0").attr("offset","0"),e.append("stop").attr("class","stop-1").attr("offset","1"),f=i.append("rect").classed("filled",!0).attr("x",0).attr("y",0).attr("width",S).attr("height",2*G),(d=r.append("g").attr("class","click-cue")).selectAll("line").data([W[8]]).enter().append("line"),d.selectAll("text").data([W[8]]).enter().append("text").text(u.click).attr("text-anchor","start"),d.style("opacity",0).style("visibility","hidden"),(l=r.append("g").attr("transform-origin","0 0 0")).selectAll("circle").data(W.slice(0,R)).enter().append("circle").attr("title",function(t,e){return"Story "+(e+1)}).style("fill",T).style("stroke-width",I).style("stroke","rgba(255, 255, 255, 0)").attr("r",D),a(".next-story").click(function(){K<R-1?K++:K=0,tt()}),s=d3.zoom().scaleExtent([1,1.7]).duration(0).on("zoom",lt),t()}(st),_(),$(!0)});