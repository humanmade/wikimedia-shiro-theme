jQuery(document).ready(function(a){"use strict";for(var n,r,s,l,o,c,y,d,f,u,p,t,i=collageAtts,h=["EN","DE","ZH","AR","FR","ES","RU"],x=["in English Wikipedia","in German Wikipedia","in Chinese Wikipedia","in Arabic Wikipedia","in French Wikipedia","in Spanish Wikipedia","in Russian Wikipedia"],g="#"+i.id,v=a(g),w=v.parent().siblings().first(),e=v.parent().find(".fake-scroll"),m=a("body"),b=a("html"),k=v.find("h1"),A=v.find("#intro-1"),C=v.find("#intro-2"),E=v.find(".recent-edits"),T=E.find(".label"),M=E.find(".title"),j=v.find(".story-overlay"),F=a("header"),q=b.width(),H=window.innerHeight,S="#202122",W=4e3,L=[{x:.56,y:.62},{x:.7,y:.52},{x:.51,y:.68},{x:.73,y:.38},{x:.28,y:.58},{x:.41,y:.59},{x:.48,y:.31},{x:.71,y:.6},{x:.65,y:.29},{x:.35,y:.33},{x:.24,y:.41},{x:.34,y:.69},{x:.57,y:.24},{x:.4,y:.23},{x:.28,y:.27},{x:.29,y:.48},{x:.66,y:.69},{x:.75,y:.46},{x:.74,y:.32},{x:.49,y:.2}],z=i.story_rgba.split("|"),O=8,R=!0,D=j.find(".story-content"),G=[],I=5,B=Math.max(h.length*I,70),N=D.length,Q=5,U=2*Q,Z=3*U,_=.1,J=.2,K=.4,P=.92,V=d3.scaleLinear().domain([K,K+.1]).range([0,1]),X=d3.scaleLinear().domain([P-.1,P]).range([1,0]),Y=1.55,$=[{path:"M2.144 15.73C3.24 10.737 5.915-.236 13.021 5.197c3.698 2.829 6.35 11.588 12.43 8.287 3.736-2.029 9.713-14.497 14.674-10.704 3.657 2.797 7.793 11.583 13.638 9.495C56.88 11.164 65.928.963 68.955 3.99c6.312 6.311 7.397 9.127 15.883 2.417 8.494-6.717 7.235-2.077 13.638 3.97 2.544 2.403 9.622.091 10.876-2.416",x:.1,y:.15,r:90},{path:"M2.144 15.73C3.24 10.737 5.915-.236 13.021 5.197c3.698 2.829 6.35 11.588 12.43 8.287 3.736-2.029 9.713-14.497 14.674-10.704 3.657 2.797 7.793 11.583 13.638 9.495C56.88 11.164 65.928.963 68.955 3.99c6.312 6.311 7.397 9.127 15.883 2.417 8.494-6.717 7.235-2.077 13.638 3.97 2.544 2.403 9.622.091 10.876-2.416",x:.62,y:.66,r:90},{path:"M41.286 5.24C31.346-1.987 23.23 1.895 22.64 15.773c-.23 5.407.69 9.012 4.661 12.775 2.71 2.567 4.086-.46 2.762-3.108C28.99 23.29 18.014 18.493 10 21.5-.5 25.44.425 40.745 7.103 44.084",x:.79,y:.87,r:0},{path:"M41.286 5.24C31.346-1.987 23.23 1.895 22.64 15.773c-.23 5.407.69 9.012 4.661 12.775 2.71 2.567 4.086-.46 2.762-3.108C28.99 23.29 18.014 18.493 10 21.5-.5 25.44.425 40.745 7.103 44.084",x:.5,y:.05,r:85},{path:"M2 2c1.3 3.96 8.346 24.812 15.63 15.01 1.913-2.574 1.124-9.324-3.16-8.69-3.538.524-4.95 7.897-5.181 10.62-.542 6.372.877 13.801 5.356 18.61C23.46 47.013 42.616 42.798 51 35.18",x:.85,y:.1,r:0},{path:"M2 2c1.3 3.96 8.346 24.812 15.63 15.01 1.913-2.574 1.124-9.324-3.16-8.69-3.538.524-4.95 7.897-5.181 10.62-.542 6.372.877 13.801 5.356 18.61C23.46 47.013 42.616 42.798 51 35.18",x:.15,y:.85,r:-100}],tt=0,et=[],it=0;G.length<B;){var nt=at(0,1),rt=at(0,1);.35<nt&&nt<.6&&.35<rt&&rt<.6||G.push({x:nt,y:rt})}function at(t,e){return(Math.random()*(e-t)+t).toFixed(2)}function st(t,e){var i=.5,n=.5,r=parseFloat(t.x),a=parseFloat(e.x),s=parseFloat(t.y),l=parseFloat(e.y);return(r-i)*(r-i)+(s-n)*(s-n)-((a-i)*(a-i)+(l-n)*(l-n))}function lt(t,e,i){var n="https://"+t.toLowerCase()+".wikipedia.org/w/api.php",r={action:"query",list:"recentchanges",rcnamespace:"0",rcprop:"title|flags|timestamp",rcstart:e,rcend:i,rctype:"edit",rcshow:"!bot",rclimit:I,format:"json"};return n+="?origin=*",Object.keys(r).forEach(function(t){n+="&"+t+"="+r[t]}),n}function ot(t){if(document.hasFocus()||t){var e=new Date,i=e.toISOString(),n=new Date(e.getTime()-36e5),r=n.toISOString();console.log(r,"\n",i,"\n",n.toLocaleTimeString()+" to "+e.toLocaleTimeString()),et=[],a.when(a.ajax(lt(h[0],i,r)),a.ajax(lt(h[1],i,r)),a.ajax(lt(h[2],i,r)),a.ajax(lt(h[3],i,r)),a.ajax(lt(h[4],i,r)),a.ajax(lt(h[5],i,r)),a.ajax(lt(h[6],i,r))).always(function(t,e,i,n,r,a,s){"success"===t[1]&&t[0].query.recentchanges.forEach(function(t){t.wiki=x[0],et.push(t)}),"success"===e[1]&&e[0].query.recentchanges.forEach(function(t){t.wiki=x[1],et.push(t)}),"success"===i[1]&&i[0].query.recentchanges.forEach(function(t){t.wiki=x[2],et.push(t)}),"success"===n[1]&&n[0].query.recentchanges.forEach(function(t){t.wiki=x[3],et.push(t)}),"success"===r[1]&&r[0].query.recentchanges.forEach(function(t){t.wiki=x[4],et.push(t)}),"success"===a[1]&&a[0].query.recentchanges.forEach(function(t){t.wiki=x[5],et.push(t)}),"success"===s[1]&&s[0].query.recentchanges.forEach(function(t){t.wiki=x[6],et.push(t)}),d3.shuffle(et),bt()})}else bt()}function ct(){var t=window.innerHeight-F.height(),e=b.width(),i=500<window.innerWidth?.6:.4;n.attr("height",t).attr("width",e).attr("viewBox","0 0 "+e+" "+t),s.range([U,t-U]),o.range([U,e-U]),l.selectAll("circle").style("opacity",0).attr("cx",function(t){return o(t.x)}).attr("cy",function(t){return s(t.y)}).transition().delay(function(t,e){return 10*e}).style("opacity",function(){return at(.1,.9)}),f.attr("transform","translate("+o(L[O].x)+", "+s(L[O].y)+")").style("opacity",1),y.selectAll("circle").attr("class","story-blob story-unread").style("opacity",0).style("visibility","hidden").attr("cx",function(t){return o(t.x)}).attr("cy",function(t){return s(t.y)}).on("mouseover",function(){var t=d3.select(this).attr("data-color");d3.select(this).transition().style("fill",t).attr("r",2*U),f.transition().style("opacity",0).style("visibility","hidden")}).on("mouseleave",function(){var t=-1<d3.select(this).attr("class").indexOf("story-read")?d3.select(this).attr("data-color"):S;d3.select(this).transition().style("fill",t).attr("r",U),f.transition().style("opacity",1).style("visibility","visible")}).on("click",ft),d.selectAll("line").attr("x1",function(t){return o(t.x)+Q}).attr("x2",function(t){return o(t.x)+3*Q}).attr("y1",function(t){return s(t.y)-2*Q}).attr("y2",function(t){return s(t.y)-5*Q}),d.selectAll("text").attr("x",function(t){return o(t.x)+3*Q}).attr("y",function(t){return s(t.y)-5*Q}).attr("dy","-5px"),j.find(".close").click(yt),m.keyup(function(t){"Escape"===t.key&&yt()}),u.attr("width",e),p.selectAll("path").attr("transform",function(t,e){return"translate("+o($[e].x)+", "+s($[e].y-.001)+") rotate("+$[e].r+") scale("+i+")"}).attr("stroke-dasharray","500 500").attr("stroke-dashoffset",500).transition().duration(1400).attr("transform",function(t,e){return"translate("+o($[e].x)+", "+s($[e].y)+") rotate("+$[e].r+") scale("+i+")"}).delay(function(t,e){return 10*B+200*e}).attr("stroke-dashoffset",0),r.call(c.transform,d3.zoomIdentity,d3.zoomTransform(r.node()).invert([e/2,t/2])),m.css("overflow","hidden auto")}function yt(){m.css("overflow","hidden auto"),wt(j),v.focus(),vt()}function dt(){D.hide(),a(D[it]).show(),ut(it),v.find(".story-nav .index").text(it+1+"/"+N),j.find(".story-content-container").scrollTop(0)}function ft(t,e){it=e,dt(),m.css("overflow","hidden"),mt(j),ut(e),d.transition().style("opacity",0).style("visibility","hidden"),f.transition().style("opacity",0).style("visibility","hidden")}function ut(i){var t=y.selectAll("circle").filter(function(t,e){return e===i}),e=t.attr("data-color");t.style("fill",e).attr("class","story-blob story-read"),i===O&&(R=!1)}function pt(){0<et.length&&(T.text(i.label+" "+et[tt].wiki),M.text(et[tt].title),mt(E),l.selectAll("circle").sort(st).filter(function(t,e){return e===tt}).transition().duration(500).style("fill","rgba"+z[tt%z.length]).style("opacity",1).attr("r",U).transition().delay(1500).style("fill",S).style("opacity",at(.1,.9)).attr("r",Q).on("end",function(){++tt<et.length?pt():(tt=0,ot())}))}function ht(){wt(E),l.selectAll("circle").filter(function(t,e){return e===tt}).interrupt().style("fill",S).style("opacity",.5).attr("r",Q)}function xt(){var t,e;return d3.select(".story-unread").each(function(){t=d3.select(this).attr("cx"),e=d3.select(this).attr("cy")}),[t,e]}function gt(){y.selectAll("circle").style("opacity",0).style("visibility","hidden").attr("r",Q),d.style("opacity",0).style("visibility","hidden"),f.style("opacity",0).style("visibility","hidden"),l.style("opacity",1)}function vt(t,e,i){var n=function(t,e,i){return t<e+.1?V(t):i-.1<t?X(t):1}(t,e,i);y.selectAll("circle").style("opacity",n).style("visibility","visible").attr("r",U),R?(d.style("opacity",n).style("filter","blur("+2*(1-n)+"px)").style("visibility","visible"),f.style("opacity",n).style("visibility","visible")):f.style("opacity",n).style("visibility","visible").attr("transform","translate("+xt()[0]+", "+xt()[1]+")"),l.style("opacity",Math.max(.1,1-n))}function wt(t){t.removeClass("visible").addClass("hidden")}function mt(t){t.removeClass("hidden").addClass("visible")}function bt(){v.show();var t=a(window).scrollTop(),e=Math.min(1+t/W/2,Y),i=((t-(w.offset().top-window.innerHeight))/window.innerHeight).toFixed(2),n=t/(w.offset().top-window.innerHeight);n<_?(r.call(c.scaleTo,e),mt(A),wt(C),wt(k),gt(),p.style("visibility","visible"),ht()):n<J?(r.call(c.scaleTo,e),wt(A),mt(C),wt(k),gt(),p.style("visibility","visible"),ht()):n<K?(r.call(c.scaleTo,e),wt(A),wt(C),mt(k),gt(),p.style("visibility","hidden"),pt()):n<P?(r.call(c.scaleTo,e),wt(A),wt(C),mt(k),vt(n,K,P),p.style("visibility","hidden"),ht()):P<=n&&(r.call(c.scaleTo,e-Math.max(0,n-P)),wt(A),wt(C),mt(k),gt(),p.style("visibility","hidden"),ht(),v.css("opacity",Math.max(0,1-i)))}function kt(){var t=d3.event.transform;r.attr("transform","translate("+t.x+","+t.y+") scale("+t.k+")")}a(window).scroll(function(){a(window).scrollTop()>=w.offset().top?v.hide():requestAnimationFrame(bt)}),a(window).resize(function(){q===b.width()&&H===window.innerHeight||(q=b.width(),H=window.innerHeight,requestAnimationFrame(function(){ct(),pt(),bt()}))}),t=2*W,e.css("height",t/window.innerHeight*100+"vh"),w.css({position:"relative","background-color":"#ffffff","padding-top":"2.5rem","padding-bottom":"0.5rem"}),function(t){a(".header-main").hide(),n=d3.select(g).append("svg"),r=n.append("g").attr("transform-origin","0 0 0"),s=d3.scaleLinear().domain([0,d3.max(G,function(t){return t.y})]),o=d3.scaleLinear().domain([0,1]),(l=r.append("g").attr("class","blobs-g")).selectAll("circle").data(G).enter().append("circle").attr("class",function(t){return t.x+" "+t.y}).style("fill",S).attr("r",Q);var e=n.append("defs").append("linearGradient").attr("id","mainGradient").attr("gradientTransform","rotate(90)");e.append("stop").attr("class","stop-0").attr("offset","0"),e.append("stop").attr("class","stop-1").attr("offset","1"),u=n.append("rect").classed("filled",!0).attr("x",0).attr("y",0).attr("width",q).attr("height",2*U),(d=r.append("g").attr("class","click-cue")).selectAll("line").data([L[O]]).enter().append("line"),d.selectAll("text").data([L[O]]).enter().append("text").text(i.click).attr("text-anchor","start"),d.style("opacity",0).style("visibility","hidden"),(f=r.append("g").attr("class","pulse-g").style("opacity",0)).append("circle").attr("class","pulse").attr("cx","0%").attr("cy","0%").attr("r",U).style("opacity",0),(y=r.append("g").attr("class","story-blobs")).selectAll("circle").data(L.slice(0,N)).enter().append("circle").attr("title",function(t,e){return"Story "+(e+1)}).attr("data-color",function(t,e){return z[e]?"rgba"+z[e]:S}).style("fill",S).style("stroke-width",Z).style("stroke","rgba(255, 255, 255, 0)").attr("r",Q),D.each(function(t){a(this).find(".story-image").css("border","4px solid rgba"+z[t])}),(p=r.append("g").attr("class","ornaments-g")).selectAll("path").data($).enter().append("path").attr("class","ornament").attr("d",function(t){return t.path}).style("stroke-width",3).style("stroke",S).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round"),v.find(".next-story").click(function(){it<N-1?it++:it=0,dt()}),v.find(".prev-story").click(function(){0<it?it--:it=N-1,dt()}),c=d3.zoom().scaleExtent([1,2]).duration(0).on("zoom",kt),t()}(bt),ct(),ot(!0)});