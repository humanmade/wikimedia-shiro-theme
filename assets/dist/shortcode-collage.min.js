jQuery(document).ready(function(a){"use strict";for(var i,r,n,o,s,c,l,d,f,t,u=collageAtts,y=["EN","DE","ZH","AR","FR","ES","RU"],h=["in English Wikipedia","in German Wikipedia","in Chinese Wikipedia","in Arabic Wikipedia","in French Wikipedia","in Spanish Wikipedia","in Russian Wikipedia"],p="#"+u.id,x=a(p),g=x.parent().siblings().first(),e=x.parent().find(".fake-scroll"),w=a("body"),m=a("html"),v=x.find("h1"),k=x.find("#intro-1"),b=x.find("#intro-2"),A=x.find(".recent-edits"),E=A.find(".label"),j=A.find(".title"),q=x.find(".story-overlay"),H=x.find(".ornaments"),S=a("header"),T=m.width(),F=window.innerHeight,L="#202122",W="#36c",C=1200,z=[{x:.56,y:.62},{x:.7,y:.52},{x:.51,y:.68},{x:.73,y:.38},{x:.29,y:.57},{x:.41,y:.61},{x:.48,y:.31},{x:.71,y:.6},{x:.65,y:.29},{x:.35,y:.32},{x:.24,y:.41},{x:.31,y:.69},{x:.57,y:.24},{x:.43,y:.23},{x:.28,y:.27}],M=q.find(".story-content"),O=[],R=5,D=Math.max(y.length*R,80),G=M.length,I=5,B=2*I,N=3*B,Q=.12,U=.24,Z=.5,J=.9,K=d3.scaleLinear().domain([Z,Z+.1]).range([0,1]),P=d3.scaleLinear().domain([J-.1,J]).range([1,0]),V=0,X=[],Y=0;O.length<D;){var $=tt(0,1),_=tt(0,1);.35<$&&$<.6&&.35<_&&_<.6||O.push({x:$,y:_})}function tt(t,e){return(Math.random()*(e-t)+t).toFixed(2)}function et(t,e,i){var n="https://"+t.toLowerCase()+".wikipedia.org/w/api.php",r={action:"query",list:"recentchanges",rcnamespace:"0",rcprop:"title|flags|timestamp",rcstart:e,rcend:i,rctype:"edit",rcshow:"!bot",rclimit:R,format:"json"};return n+="?origin=*",Object.keys(r).forEach(function(t){n+="&"+t+"="+r[t]}),n}function it(t){if(document.hasFocus()||t){var e=new Date,i=e.toISOString(),n=new Date(e.getTime()-36e5),r=n.toISOString();console.log(r,"\n",i,"\n",n.toLocaleTimeString()+" to "+e.toLocaleTimeString()),X=[],a.when(a.ajax(et(y[0],i,r)),a.ajax(et(y[1],i,r)),a.ajax(et(y[2],i,r)),a.ajax(et(y[3],i,r)),a.ajax(et(y[4],i,r)),a.ajax(et(y[5],i,r)),a.ajax(et(y[6],i,r))).always(function(t,e,i,n,r,a,o){"success"===t[1]&&t[0].query.recentchanges.forEach(function(t){t.wiki=h[0],X.push(t)}),"success"===e[1]&&e[0].query.recentchanges.forEach(function(t){t.wiki=h[1],X.push(t)}),"success"===i[1]&&i[0].query.recentchanges.forEach(function(t){t.wiki=h[2],X.push(t)}),"success"===n[1]&&n[0].query.recentchanges.forEach(function(t){t.wiki=h[3],X.push(t)}),"success"===r[1]&&r[0].query.recentchanges.forEach(function(t){t.wiki=h[4],X.push(t)}),"success"===a[1]&&a[0].query.recentchanges.forEach(function(t){t.wiki=h[5],X.push(t)}),"success"===o[1]&&o[0].query.recentchanges.forEach(function(t){t.wiki=h[6],X.push(t)}),d3.shuffle(X),yt()})}else yt()}function nt(){var t=window.innerHeight-S.height(),e=m.width();i.attr("height",t).attr("width",e).attr("viewBox","0 0 "+e+" "+t),n.range([B,t-B]),s.range([B,e-B]),o.selectAll("circle").style("opacity",0).attr("cx",function(t){return s(t.x)}).attr("cy",function(t){return n(t.y)}).transition().delay(function(t,e){return 10*e}).style("opacity",function(){return tt(.1,.9)}),l.selectAll("circle").attr("class","story-blob story-unread").style("opacity",0).style("visibility","hidden").attr("cx",function(t){return s(t.x)}).attr("cy",function(t){return n(t.y)}).on("mouseover",function(){var t=d3.select(this).attr("data-color");d3.select(this).transition().style("fill",t).attr("r",2*B)}).on("mouseleave",function(){var t=-1<d3.select(this).attr("class").indexOf("story-read")?d3.select(this).attr("data-color"):L;d3.select(this).transition().style("fill",t).attr("r",B)}).on("click",at),d.selectAll("line").attr("x1",function(t){return s(t.x)+I}).attr("x2",function(t){return s(t.x)+3*I}).attr("y1",function(t){return n(t.y)-2*I}).attr("y2",function(t){return n(t.y)-5*I}),d.selectAll("text").attr("x",function(t){return s(t.x)+3*I}).attr("y",function(t){return n(t.y)-5*I}).attr("dy","-5px"),q.find(".close").click(function(){w.css("overflow","hidden auto"),ft(q)}),f.attr("width",e),r.call(c.transform,d3.zoomIdentity,d3.zoomTransform(r.node()).invert([e/2,t/2])),w.css("overflow","hidden auto")}function rt(){M.hide(),a(M[Y]).show(),0===Y?(ut(x.find(".next-story")),ft(x.find(".prev-story"))):(Y===G-1?ft(x.find(".next-story")):ut(x.find(".next-story")),ut(x.find(".prev-story"))),ot(Y)}function at(t,e){Y=e,rt(),w.css("overflow","hidden"),ut(q),ot(e),d.transition().style("opacity",0).style("visibility","hidden")}function ot(i){var t=l.selectAll("circle").filter(function(t,e){return e===i}),e=t.attr("data-color");t.style("fill",e).attr("class","story-blob story-read")}function st(){0<X.length&&(E.text(u.label+" "+X[V].wiki),j.text(X[V].title),ut(A),o.selectAll("circle").filter(function(t,e){return e===V}).transition().duration(500).style("fill",W).style("opacity",1).attr("r",B).transition().delay(1500).style("fill",L).style("opacity",tt(.1,.9)).attr("r",I).on("end",function(){++V<X.length?st():(V=0,it())}))}function ct(){ft(A),o.selectAll("circle").filter(function(t,e){return e===V}).interrupt().style("fill",L).style("opacity",.5).attr("r",I)}function lt(){l.selectAll("circle").style("opacity",0).style("visibility","hidden").attr("r",I),d.style("opacity",0).style("visibility","hidden"),o.style("opacity",1)}function dt(t,e,i){var n=function(t,e,i){return t<e+.1?K(t):i-.1<t?P(t):1}(t,e,i);l.selectAll("circle").style("opacity",n).style("visibility","visible").attr("r",B),d.style("opacity",n).style("filter","blur("+2*(1-n)+"px)").style("visibility","visible"),o.style("opacity",Math.max(.1,1-n))}function ft(t){t.removeClass("visible").addClass("hidden")}function ut(t){t.removeClass("hidden").addClass("visible")}function yt(){x.show();var t=a(window).scrollTop(),e=1+t/C/2,i=((t-(g.offset().top-window.innerHeight))/window.innerHeight).toFixed(2),n=t/(g.offset().top-window.innerHeight);r.call(c.scaleTo,e),n<Q?(ut(k),ft(b),ft(v),lt(),ct(),ft(q),ut(H)):n<U?(ft(k),ut(b),ft(v),lt(),ct(),ft(q),ut(H)):n<Z?(ft(k),ft(b),ut(v),lt(),st(),ft(q),ft(H)):n<J?(ft(k),ft(b),ut(v),dt(n,Z,J),ct(),ft(H)):J<=n&&(ft(k),ft(b),ut(v),lt(),ct(),ft(q),x.css("opacity",Math.max(0,1-i)),ft(H))}function ht(){var t=d3.event.transform;r.attr("transform","translate("+t.x+","+t.y+") scale("+t.k+")")}a(window).scroll(function(){a(window).scrollTop()>=g.offset().top?x.hide():requestAnimationFrame(yt)}),a(window).resize(function(){T===m.width()&&F===window.innerHeight||(T=m.width(),F=window.innerHeight,requestAnimationFrame(function(){nt(),st(),yt()}))}),t=2*C,e.css("height",t/window.innerHeight*100+"vh"),g.css({position:"relative","background-color":"#ffffff","padding-top":"2.5rem","padding-bottom":"0.5rem"}),function(t){a(".header-main").hide(),i=d3.select(p).append("svg"),r=i.append("g").attr("transform-origin","0 0 0"),n=d3.scaleLinear().domain([0,d3.max(O,function(t){return t.y})]),s=d3.scaleLinear().domain([0,1]),(o=r.append("g")).selectAll("circle").data(O).enter().append("circle").attr("class",function(t){return t.x+" "+t.y}).style("fill",L).attr("r",I);var e=i.append("defs").append("linearGradient").attr("id","mainGradient").attr("gradientTransform","rotate(90)");e.append("stop").attr("class","stop-0").attr("offset","0"),e.append("stop").attr("class","stop-1").attr("offset","1"),f=i.append("rect").classed("filled",!0).attr("x",0).attr("y",0).attr("width",T).attr("height",2*B),(d=r.append("g").attr("class","click-cue")).selectAll("line").data([z[8]]).enter().append("line"),d.selectAll("text").data([z[8]]).enter().append("text").text(u.click).attr("text-anchor","start"),d.style("opacity",0).style("visibility","hidden"),(l=r.append("g").attr("transform-origin","0 0 0")).selectAll("circle").data(z.slice(0,G)).enter().append("circle").attr("title",function(t,e){return"Story "+(e+1)}).attr("data-color",function(){return"rgb("+tt(0,255)+","+tt(0,255)+","+tt(0,255)+")"}).style("fill",L).style("stroke-width",N).style("stroke","rgba(255, 255, 255, 0)").attr("r",I),x.find(".next-story").click(function(){Y<G-1&&(Y++,rt())}),x.find(".prev-story").click(function(){0<Y&&(Y--,rt())}),c=d3.zoom().scaleExtent([1,1.7]).duration(0).on("zoom",ht),t()}(yt),nt(),it(!0)});