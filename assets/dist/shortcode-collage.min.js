jQuery(document).ready(function(r){"use strict";var n,a,i,s,c,o,l,d,f,t,u=collageAtts,y=["EN","DE","ZH","AR","FR","ES","RU"],p=["in English Wikipedia","in German Wikipedia","in Chinese Wikipedia","in Arabic Wikipedia","in French Wikipedia","in Spanish Wikipedia","in Russian Wikipedia"],h="#"+u.id,m=r(h),x=m.parent().siblings().first(),e=m.parent().find(".fake-scroll"),g=r("body"),w=r("html"),v=m.find("h1"),k=m.find(".intro"),b=m.find(".recent-edits"),A=b.find(".label"),N=b.find(".title"),E=m.find(".story-overlay"),j=r("header").height(),q=w.width(),S="#202122",T="#36c",F=1200,L=[{x:.56,y:.62,name:"Name 1"},{x:.7,y:.52,name:"Name 2"},{x:.51,y:.68,name:"Name 3"},{x:.73,y:.38,name:"Name 4"},{x:.29,y:.57,name:"Name 5"},{x:.41,y:.61,name:"Name 6"},{x:.48,y:.27,name:"Name 7"},{x:.71,y:.6,name:"Name 8"},{x:.65,y:.29,name:"Name 9"},{x:.35,y:.32,name:"Name 10"},{x:.24,y:.41,name:"Name 11"},{x:.31,y:.69,name:"Name 12"},{x:.57,y:.24,name:"Name 13"},{x:.43,y:.2,name:"Name 14"},{x:.3,y:.25,name:"Name 15"}],W=[],C=5,H=Math.max(y.length*C,80),z=5,M=2*z,R=3*M,D=.12,G=.5,I=.9,O=d3.scaleLinear().domain([G,G+.1]).range([0,1]),B=d3.scaleLinear().domain([I-.1,I]).range([1,0]),Q=0,U=[];for(console.log("collage",u);W.length<H;){var Z=K(0,1),J=K(0,1);.35<Z&&Z<.6&&.35<J&&J<.6||W.push({x:Z,y:J})}function K(t,e){return(Math.random()*(e-t)+t).toFixed(2)}function P(t,e,n){var i="https://"+t.toLowerCase()+".wikipedia.org/w/api.php",a={action:"query",list:"recentchanges",rcnamespace:"0",rcprop:"title|flags|timestamp",rcstart:e,rcend:n,rctype:"edit",rcshow:"!bot",rclimit:C,format:"json"};return i+="?origin=*",Object.keys(a).forEach(function(t){i+="&"+t+"="+a[t]}),i}function V(t){if(document.hasFocus()||t){var e=new Date,n=e.toISOString(),i=new Date(e.getTime()-36e5),a=i.toISOString();console.log(a,"\n",n,"\n",i.toLocaleTimeString()+" to "+e.toLocaleTimeString()),U=[],r.when(r.ajax(P(y[0],n,a)),r.ajax(P(y[1],n,a)),r.ajax(P(y[2],n,a)),r.ajax(P(y[3],n,a)),r.ajax(P(y[4],n,a)),r.ajax(P(y[5],n,a)),r.ajax(P(y[6],n,a))).always(function(t,e,n,i,a,r,s){"success"===t[1]&&t[0].query.recentchanges.forEach(function(t){t.wiki=p[0],U.push(t)}),"success"===e[1]&&e[0].query.recentchanges.forEach(function(t){t.wiki=p[1],U.push(t)}),"success"===n[1]&&n[0].query.recentchanges.forEach(function(t){t.wiki=p[2],U.push(t)}),"success"===i[1]&&i[0].query.recentchanges.forEach(function(t){t.wiki=p[3],U.push(t)}),"success"===a[1]&&a[0].query.recentchanges.forEach(function(t){t.wiki=p[4],U.push(t)}),"success"===r[1]&&r[0].query.recentchanges.forEach(function(t){t.wiki=p[5],U.push(t)}),"success"===s[1]&&s[0].query.recentchanges.forEach(function(t){t.wiki=p[6],U.push(t)}),d3.shuffle(U),at()})}else at()}function X(){var t=window.innerHeight-j,e=w.width();n.attr("height",t).attr("width",e).attr("viewBox","0 0 "+e+" "+t),i.range([M,t-M]),c.range([M,e-M]),s.selectAll("circle").style("opacity",0).attr("cx",function(t){return c(t.x)}).attr("cy",function(t){return i(t.y)}).transition().delay(function(t,e){return 10*e}).style("opacity",function(){return K(.1,.9)}),l.selectAll("circle").attr("class","story-blob").style("opacity",0).style("visibility","hidden").attr("cx",function(t){return c(t.x)}).attr("cy",function(t){return i(t.y)}).on("mouseover",function(){d3.select(this).transition().style("fill",T).attr("r",2*M)}).on("mouseleave",function(){d3.select(this).transition().style("fill",S).attr("r",M)}).on("click",Y),d.selectAll("line").attr("x1",function(t){return c(t.x)+z}).attr("x2",function(t){return c(t.x)+3*z}).attr("y1",function(t){return i(t.y)-2*z}).attr("y2",function(t){return i(t.y)-5*z}),d.selectAll("text").attr("x",function(t){return c(t.x)+3*z}).attr("y",function(t){return i(t.y)-5*z}).attr("dy","-5px"),E.find(".close").click(function(){g.css("overflow","hidden auto"),nt(E)}),f.attr("width",e),a.call(o.transform,d3.zoomIdentity,d3.zoomTransform(a.node()).invert([e/2,t/2]))}function Y(){E.find("h2").text(d3.select(this).data()[0].name),g.css("overflow","hidden"),it(E),d.transition().style("opacity",0).style("visibility","hidden")}function $(){0<U.length&&(A.text(u.label+" "+U[Q].wiki),N.text(U[Q].title),it(b),s.selectAll("circle").filter(function(t,e){return e===Q}).transition().duration(500).style("fill",T).style("opacity",1).attr("r",M).transition().delay(1500).style("fill",S).style("opacity",K(.1,.9)).attr("r",z).on("end",function(){++Q<U.length?$():(Q=0,V())}))}function _(){nt(b),s.selectAll("circle").filter(function(t,e){return e===Q}).interrupt().style("fill",S).style("opacity",.5).attr("r",z)}function tt(){l.selectAll("circle").style("opacity",0).style("visibility","hidden").attr("r",z),d.style("opacity",0).style("visibility","hidden"),s.style("opacity",1)}function et(t,e,n){var i=function(t,e,n){return t<e+.1?O(t):n-.1<t?B(t):1}(t,e,n);l.selectAll("circle").style("opacity",i).style("visibility","visible").attr("r",M),d.style("opacity",i).style("visibility","visible"),s.style("opacity",Math.max(.1,1-i))}function nt(t){t.removeClass("visible").addClass("hidden")}function it(t){t.removeClass("hidden").addClass("visible")}function at(){m.show();var t=r(window).scrollTop(),e=1+t/F/2,n=((t-(x.offset().top-window.innerHeight))/window.innerHeight).toFixed(2),i=t/(x.offset().top-window.innerHeight);a.call(o.scaleTo,e),i<D?(it(k),nt(v),tt(),_(),nt(E)):i<G?(nt(k),it(v),tt(),$(),nt(E)):i<I?(nt(k),it(v),et(i,G,I),_()):I<=i&&(nt(k),it(v),tt(),_(),nt(E),m.css("opacity",Math.max(0,1-n)))}function rt(){var t=d3.event.transform;a.attr("transform","translate("+t.x+","+t.y+") scale("+t.k+")")}r(window).scroll(function(){r(window).scrollTop()>=x.offset().top?m.hide():requestAnimationFrame(at)}),r(window).resize(function(){q!==w.width()&&(q=w.width(),requestAnimationFrame(function(){X(),$(),at()}))}),t=2*F,e.css("height",t/window.innerHeight*100+"vh"),x.css({position:"relative","background-color":"#ffffff","padding-top":"2.5rem","padding-bottom":"0.5rem"}),function(t){n=d3.select(h).append("svg"),a=n.append("g").attr("transform-origin","0 0 0"),i=d3.scaleLinear().domain([0,d3.max(W,function(t){return t.y})]),c=d3.scaleLinear().domain([0,1]),(s=a.append("g")).selectAll("circle").data(W).enter().append("circle").attr("class",function(t){return t.x+" "+t.y}).style("fill",S).attr("r",z);var e=n.append("defs").append("linearGradient").attr("id","mainGradient").attr("gradientTransform","rotate(90)");e.append("stop").attr("class","stop-0").attr("offset","0"),e.append("stop").attr("class","stop-1").attr("offset","1"),f=n.append("rect").classed("filled",!0).attr("x",0).attr("y",0).attr("width",q).attr("height",2*M),(d=a.append("g").attr("class","click-cue")).selectAll("line").data([L[8]]).enter().append("line"),d.selectAll("text").data([L[8]]).enter().append("text").text(u.click).attr("text-anchor","start"),d.style("opacity",0).style("visibility","hidden"),(l=a.append("g").attr("transform-origin","0 0 0")).selectAll("circle").data(L.slice(0,15)).enter().append("circle").attr("title",function(t,e){return"Story "+(e+1)}).style("fill",S).style("stroke-width",R).style("stroke","rgba(255, 255, 255, 0)").attr("r",z),o=d3.zoom().scaleExtent([1,1.7]).duration(0).on("zoom",rt),t()}(at),X(),V(!0)});