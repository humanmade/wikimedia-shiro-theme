jQuery(document).ready(function(a){"use strict";for(var n,s,l,o,c,y,d,f,u,p,h,x,t,r=collageAtts,g=["EN","DE","ZH","AR","FR","ES","RU"],m=["English Wikipedia","German Wikipedia","Chinese Wikipedia","Arabic Wikipedia","French Wikipedia","Spanish Wikipedia","Russian Wikipedia"],v="#"+r.id,b=a(v),w=b.parent().siblings().first(),e=b.parent().find(".fake-scroll"),k=a("body"),A=a("html"),C=b.find("#intro-1"),E=b.find("#intro-2"),M=b.find("#intro-3"),j=b.find("#intro-4"),i=b.find(".recent-edits"),q=i.find(".label"),F=i.find(".title"),H=b.find(".story-overlay"),T=a("header"),S=A.width(),W=window.innerHeight,L="#202122",z=4*window.innerHeight,O=[{x:.66,y:.28},{x:.23,y:.4},{x:.57,y:.63},{x:.71,y:.53},{x:.52,y:.72},{x:.74,y:.39},{x:.27,y:.59},{x:.4,y:.6},{x:.47,y:.3},{x:.72,y:.61},{x:.34,y:.32},{x:.33,y:.7},{x:.58,y:.23},{x:.39,y:.22},{x:.27,y:.26},{x:.28,y:.47},{x:.67,y:.7},{x:.77,y:.45},{x:.75,y:.31},{x:.48,y:.19}],R=d3.shuffle(r.story_rgba.split("|")),D=0,G=!0,I=H.find(".story-content"),B=O,Q=5,N=Math.max(g.length*Q,70),U=I.length,Z=5,_=2*Z,J=_,K=.12,P=.24,V=.72,X=1,Y=.08,$=d3.scaleLinear().domain([P,P+Y]).range([0,1]),tt=d3.scaleLinear().domain([V-Y,V]).range([1,0]),et=[0,1,2],it=d3.scaleQuantize().domain([P+1.5*Y,V-1.5*Y]).range(et),rt=1.55,nt=[{path:"M2.144 15.73C3.24 10.737 5.915-.236 13.021 5.197c3.698 2.829 6.35 11.588 12.43 8.287 3.736-2.029 9.713-14.497 14.674-10.704 3.657 2.797 7.793 11.583 13.638 9.495C56.88 11.164 65.928.963 68.955 3.99c6.312 6.311 7.397 9.127 15.883 2.417 8.494-6.717 7.235-2.077 13.638 3.97 2.544 2.403 9.622.091 10.876-2.416",x:.25,y:.3,r:90},{path:"M2.144 15.73C3.24 10.737 5.915-.236 13.021 5.197c3.698 2.829 6.35 11.588 12.43 8.287 3.736-2.029 9.713-14.497 14.674-10.704 3.657 2.797 7.793 11.583 13.638 9.495C56.88 11.164 65.928.963 68.955 3.99c6.312 6.311 7.397 9.127 15.883 2.417 8.494-6.717 7.235-2.077 13.638 3.97 2.544 2.403 9.622.091 10.876-2.416",x:.62,y:.66,r:90},{path:"M41.286 5.24C31.346-1.987 23.23 1.895 22.64 15.773c-.23 5.407.69 9.012 4.661 12.775 2.71 2.567 4.086-.46 2.762-3.108C28.99 23.29 18.014 18.493 10 21.5-.5 25.44.425 40.745 7.103 44.084",x:.45,y:.27,r:0},{path:"M41.286 5.24C31.346-1.987 23.23 1.895 22.64 15.773c-.23 5.407.69 9.012 4.661 12.775 2.71 2.567 4.086-.46 2.762-3.108C28.99 23.29 18.014 18.493 10 21.5-.5 25.44.425 40.745 7.103 44.084",x:.75,y:.4,r:85},{path:"M2 2c1.3 3.96 8.346 24.812 15.63 15.01 1.913-2.574 1.124-9.324-3.16-8.69-3.538.524-4.95 7.897-5.181 10.62-.542 6.372.877 13.801 5.356 18.61C23.46 47.013 42.616 42.798 51 35.18",x:.3,y:.6,r:0},{path:"M2 2c1.3 3.96 8.346 24.812 15.63 15.01 1.913-2.574 1.124-9.324-3.16-8.69-3.538.524-4.95 7.897-5.181 10.62-.542 6.372.877 13.801 5.356 18.61C23.46 47.013 42.616 42.798 51 35.18",x:.65,y:.25,r:-100}],at=0,st=[],lt=0;B.length<N;){var ot=yt(0,1),ct=yt(0,1);.35<ot&&ot<.6&&.35<ct&&ct<.6||B.push({x:ot,y:ct})}function yt(t,e){return(Math.random()*(e-t)+t).toFixed(2)}function dt(t,e){var i=.5,r=.5,n=parseFloat(t.x),a=parseFloat(e.x),s=parseFloat(t.y),l=parseFloat(e.y);return(n-i)*(n-i)+(s-r)*(s-r)-((a-i)*(a-i)+(l-r)*(l-r))}function ft(t,e,i){var r="https://"+t.toLowerCase()+".wikipedia.org/w/api.php",n={action:"query",list:"recentchanges",rcnamespace:"0",rcprop:"title|flags|timestamp",rcstart:e,rcend:i,rctype:"edit",rcshow:"!bot",rclimit:Q,format:"json"};return r+="?origin=*",Object.keys(n).forEach(function(t){r+="&"+t+"="+n[t]}),r}function ut(t){if(document.hasFocus()||t){var e=new Date,i=e.toISOString(),r=new Date(e.getTime()-36e5),n=r.toISOString();console.log(n,"\n",i,"\n",r.toLocaleTimeString()+" to "+e.toLocaleTimeString()),st=[],a.when(a.ajax(ft(g[0],i,n)),a.ajax(ft(g[1],i,n)),a.ajax(ft(g[2],i,n)),a.ajax(ft(g[3],i,n)),a.ajax(ft(g[4],i,n)),a.ajax(ft(g[5],i,n)),a.ajax(ft(g[6],i,n))).always(function(t,e,i,r,n,a,s){"success"===t[1]&&t[0].query.recentchanges.forEach(function(t){t.wiki=m[0],st.push(t)}),"success"===e[1]&&e[0].query.recentchanges.forEach(function(t){t.wiki=m[1],st.push(t)}),"success"===i[1]&&i[0].query.recentchanges.forEach(function(t){t.wiki=m[2],st.push(t)}),"success"===r[1]&&r[0].query.recentchanges.forEach(function(t){t.wiki=m[3],st.push(t)}),"success"===n[1]&&n[0].query.recentchanges.forEach(function(t){t.wiki=m[4],st.push(t)}),"success"===a[1]&&a[0].query.recentchanges.forEach(function(t){t.wiki=m[5],st.push(t)}),"success"===s[1]&&s[0].query.recentchanges.forEach(function(t){t.wiki=m[6],st.push(t)}),d3.shuffle(st),Mt()})}else Mt()}function pt(t){var e=window.innerHeight-T.height(),i=A.width(),r=500<window.innerWidth?.5:.4;return n.attr("height",e).attr("width",i).attr("viewBox","0 0 "+i+" "+e),l.range([_,e-_]),c.range([_,i-_]),s.call(y.transform,d3.zoomIdentity,d3.zoomTransform(s.node()).invert([i/2,e/2])).call(y.scaleTo,rt),o.selectAll("circle").style("opacity",0).attr("cx",function(t){return c(t.x)}).attr("cy",function(t){return l(t.y)}).transition().delay(function(t,e){return 10*e}).style("opacity",function(){return yt(.1,.7)}),p.attr("transform","translate("+c(O[D].x)+", "+l(O[D].y)+")").style("opacity",1),f.selectAll("circle").style("opacity",0).style("visibility","hidden").attr("transform",function(t){return"translate("+c(t.x)+", "+l(t.y)+")"}),d.selectAll("circle").attr("class","story-blob story-unread").style("opacity",0).style("visibility","hidden").attr("transform",function(t){return"translate("+c(t.x)+", "+l(t.y)+") scale(1)"}).on("mouseover",function(){var t=d3.select(this).attr("data-color");d3.select(this).transition().style("fill",t).attr("transform",function(t){return"translate("+c(t.x)+", "+l(t.y)+") scale(4.5)"}),p.style("opacity",0).style("visibility","hidden")}).on("mouseleave",function(){var t=-1<d3.select(this).attr("class").indexOf("story-read")?d3.select(this).attr("data-color"):L;d3.select(this).transition().style("fill",t).attr("transform",function(t){return"translate("+c(t.x)+", "+l(t.y)+") scale(2)"}),p.style("opacity",1).style("visibility","visible")}).on("click",gt),u.selectAll("line").attr("x1",Z).attr("x2",3*Z).attr("y1",2*-Z).attr("y2",5*-Z),u.selectAll("text").attr("x",3*Z).attr("y",5*-Z).attr("dy","-5px"),H.find(".close").click(ht),k.keyup(function(t){"Escape"===t.key&&ht()}),h.attr("width",i),x.selectAll("path").attr("transform",function(t,e){return"translate("+c(nt[e].x)+", "+l(nt[e].y-.001)+") rotate("+nt[e].r+") scale("+r+")"}).attr("stroke-dasharray","500 500").attr("stroke-dashoffset",500).transition().duration(1400).attr("transform",function(t,e){return"translate("+c(nt[e].x)+", "+l(nt[e].y)+") rotate("+nt[e].r+") scale("+r+")"}).delay(function(t,e){return 10*N+200*e}).attr("stroke-dashoffset",0),k.css("overflow","hidden auto"),!!t&&t()}function ht(){k.css("overflow","hidden auto"),Ct(H),b.focus(),At()}function xt(){I.hide(),a(I[lt]).show(),mt(lt),b.find(".story-nav .index").text(lt+1+"/"+U),H.find(".story-content-container").scrollTop(0)}function gt(t,e){lt=e,xt(),k.css("overflow","hidden"),Et(H),mt(e),u.transition().style("opacity",0).style("visibility","hidden"),p.transition().style("opacity",0).style("visibility","hidden")}function mt(i){var t=d.selectAll("circle").filter(function(t,e){return e===i}),e=t.attr("data-color");t.style("fill",e).attr("class","story-blob story-read"),i===D&&(G=!1)}function vt(){var t="rgba"+R[at%R.length];0<st.length&&(q.text(r.label+" "+st[at].wiki),F.text(st[at].title),Et(i),i.find(".accent").css("border","1px solid "+t),o.selectAll("circle").sort(dt).filter(function(t,e){return e===at}).transition().duration(500).style("fill",t).style("opacity",1).attr("r",_).transition().delay(1500).style("fill",L).style("opacity",yt(.1,.9)).attr("r",Z).on("end",function(){++at<st.length?vt():(at=0,ut())}))}function bt(){Ct(i),o.selectAll("circle").filter(function(t,e){return e===at}).interrupt().style("fill",L).style("opacity",.5).attr("r",Z)}function wt(t,e,i){return t<e+Y?$(t):i-Y<t?tt(t):1}function kt(){d.selectAll("circle").style("opacity",0).style("visibility","hidden").attr("transform",function(t){return"translate("+c(t.x)+", "+l(t.y)+") scale(1)"}),f.selectAll("circle").style("opacity",0).style("visibility","hidden"),u.style("opacity",0).style("visibility","hidden"),p.style("opacity",0).style("visibility","hidden"),o.style("opacity",1)}function At(i,t,e){var r=wt(i,t,e),n=.4<r?wt(i<.5*(t+e)?i-Y:i+Y,t,e):0,a=d.selectAll("circle").filter(function(t,e){return e===it(i)}).attr("transform").split(") ")[0]+")";f.selectAll("circle").style("opacity",function(t,e){return e===it(i)?n:0}).style("visibility","visible"),d.selectAll("circle").style("opacity",r).style("visibility","visible").attr("transform",function(t){return"translate("+c(t.x)+", "+l(t.y)+") scale("+Math.max(1.8*r,1)+")"}),G?(u.style("opacity",n).style("filter","blur("+2*(1-r)+"px)").style("visibility","visible").attr("transform",a),p.style("opacity",n).style("visibility","visible").attr("transform",a)):p.style("opacity",n).style("visibility","visible").attr("transform",a).style("stroke",R[D]?"rgba"+R[D]:L),o.style("opacity",Math.max(.2,1-r))}function Ct(t){t.removeClass("visible").addClass("hidden")}function Et(t){t.removeClass("hidden").addClass("visible")}function Mt(){b.show();var t=a(window).scrollTop(),e=Math.min(rt-t/z/4,rt),i=((t-(w.offset().top-window.innerHeight))/window.innerHeight).toFixed(2),r=t/(w.offset().top-.65*window.innerHeight);b.css("opacity",Math.max(0,1-i)),s.call(y.scaleTo,e),r<K?(Et(C),Ct(E),Ct(M),Ct(j),kt(),x.style("visibility","visible"),bt()):r<P?(Ct(C),Et(E),Ct(M),Ct(j),kt(),x.style("visibility","visible"),bt()):r<V?(Ct(C),Ct(E),Et(M),Ct(j),At(r,P,V),x.style("visibility","hidden"),bt()):r<X?(Ct(C),Ct(E),Ct(M),Et(j),kt(),x.style("visibility","hidden"),vt(),b.css("opacity",1)):X<=r&&(Ct(C),Ct(E),Ct(M),Ct(j),kt(),x.style("visibility","hidden"),bt())}function jt(){var t=d3.event.transform;s.attr("transform","translate("+t.x+","+t.y+") scale("+t.k+")")}a(window).scroll(function(){a(window).scrollTop()>=w.offset().top?b.hide():requestAnimationFrame(Mt)}),a(window).resize(function(){S===A.width()&&W===window.innerHeight||(S=A.width(),W=window.innerHeight,requestAnimationFrame(function(){pt(),vt(),Mt()}))}),t=2*z,e.css("height",t/window.innerHeight*100+"vh"),w.css({position:"relative","background-color":"#ffffff","padding-top":"2.5rem","padding-bottom":"0.5rem"}),function(){a(".header-main").hide(),n=d3.select(v).append("svg"),s=n.append("g").attr("transform-origin","0 0 0"),l=d3.scaleLinear().domain([0,d3.max(B,function(t){return t.y})]),c=d3.scaleLinear().domain([0,1]),(o=s.append("g").attr("class","blobs-g")).selectAll("circle").data(B).enter().append("circle").attr("class",function(t){return t.x+" "+t.y}).style("fill",L).attr("r",Z);var t=n.append("defs").append("linearGradient").attr("id","mainGradient").attr("gradientTransform","rotate(90)");t.append("stop").attr("class","stop-0").attr("offset","0"),t.append("stop").attr("class","stop-1").attr("offset","1"),h=n.append("rect").classed("filled",!0).attr("x",0).attr("y",0).attr("width",S).attr("height",2*_),(u=s.append("g").attr("class","click-cue")).selectAll("line").data([O[D]]).enter().append("line"),u.selectAll("text").data([O[D]]).enter().append("text").text(r.click).attr("text-anchor","start"),u.style("opacity",0).style("visibility","hidden"),(p=s.append("g").attr("class","pulse-g").style("opacity",0)).append("circle").attr("class","pulse").attr("cx","0").attr("cy","0").style("stroke",L).attr("r",_).style("opacity",0),(f=s.append("g").attr("class","story-blobs-clones")).selectAll("circle").data(O.slice(0,et.length)).enter().append("circle").attr("data-color",function(t,e){return R[e]?"rgba"+R[e]:L}).style("fill",function(t,e){return R[e]?"rgba"+R[e]:L}).attr("r",3.5*Z).attr("cy",0).attr("cx",0),(d=s.append("g").attr("class","story-blobs")).selectAll("circle").data(O.slice(0,U)).enter().append("circle").attr("data-title",function(t,e){return"Story "+(e+1)}).attr("data-color",function(t,e){return R[e]?"rgba"+R[e]:L}).style("fill",L).style("stroke-width",J).style("stroke","rgba(255, 255, 255, 0)").attr("r",Z).attr("cy",0).attr("cx",0);for(var e=0;e<5;e++){var i=Math.min(Math.floor(yt(0,U)),U-1);I.eq(i).insertBefore(I[0])}(I=H.find(".story-content")).each(function(t){a(this).find(".story-image").css("border","4px solid rgba"+R[t])}),(x=s.append("g").attr("class","ornaments-g")).selectAll("path").data(nt).enter().append("path").attr("class","ornament").attr("d",function(t){return t.path}).style("stroke-width",3).style("stroke",L).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round"),b.find(".next-story").click(function(){lt<U-1?lt++:lt=0,xt()}),b.find(".prev-story").click(function(){0<lt?lt--:lt=U-1,xt()}),y=d3.zoom().scaleExtent([1,2]).duration(0).on("zoom",jt)}(),pt(Mt),ut(!0)});