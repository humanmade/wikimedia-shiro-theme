jQuery(document).ready(function(a){"use strict";for(var n,r,s,o,l,c,d,y,f,u,p,t,i=collageAtts,h=["EN","DE","ZH","AR","FR","ES","RU"],x=["English Wikipedia","German Wikipedia","Chinese Wikipedia","Arabic Wikipedia","French Wikipedia","Spanish Wikipedia","Russian Wikipedia"],g="#"+i.id,v=a(g),w=v.parent().siblings().first(),e=v.parent().find(".fake-scroll"),b=a("body"),m=a("html"),k=v.find("#intro-1"),A=v.find("#intro-2"),C=v.find("#intro-3"),E=v.find("#intro-4"),j=v.find(".recent-edits"),F=j.find(".label"),M=j.find(".title"),q=v.find(".story-overlay"),H=a("header"),S=m.width(),T=window.innerHeight,W="#202122",L=4e3,z=[{x:.56,y:.62},{x:.7,y:.52},{x:.51,y:.68},{x:.73,y:.38},{x:.28,y:.58},{x:.41,y:.59},{x:.48,y:.31},{x:.71,y:.6},{x:.65,y:.29},{x:.35,y:.33},{x:.24,y:.41},{x:.34,y:.69},{x:.57,y:.24},{x:.4,y:.23},{x:.28,y:.27},{x:.29,y:.48},{x:.66,y:.69},{x:.75,y:.46},{x:.74,y:.32},{x:.49,y:.2}],O=i.story_rgba.split("|"),R=8,D=!0,G=q.find(".story-content"),I=[],B=5,N=Math.max(h.length*B,70),Q=G.length,U=5,Z=2*U,_=3*Z,J=.1,K=.2,P=.72,V=1,X=d3.scaleLinear().domain([K,K+.1]).range([0,1]),Y=d3.scaleLinear().domain([P-.1,P]).range([1,0]),$=1.55,tt=[{path:"M2.144 15.73C3.24 10.737 5.915-.236 13.021 5.197c3.698 2.829 6.35 11.588 12.43 8.287 3.736-2.029 9.713-14.497 14.674-10.704 3.657 2.797 7.793 11.583 13.638 9.495C56.88 11.164 65.928.963 68.955 3.99c6.312 6.311 7.397 9.127 15.883 2.417 8.494-6.717 7.235-2.077 13.638 3.97 2.544 2.403 9.622.091 10.876-2.416",x:.25,y:.3,r:90},{path:"M2.144 15.73C3.24 10.737 5.915-.236 13.021 5.197c3.698 2.829 6.35 11.588 12.43 8.287 3.736-2.029 9.713-14.497 14.674-10.704 3.657 2.797 7.793 11.583 13.638 9.495C56.88 11.164 65.928.963 68.955 3.99c6.312 6.311 7.397 9.127 15.883 2.417 8.494-6.717 7.235-2.077 13.638 3.97 2.544 2.403 9.622.091 10.876-2.416",x:.62,y:.66,r:90},{path:"M41.286 5.24C31.346-1.987 23.23 1.895 22.64 15.773c-.23 5.407.69 9.012 4.661 12.775 2.71 2.567 4.086-.46 2.762-3.108C28.99 23.29 18.014 18.493 10 21.5-.5 25.44.425 40.745 7.103 44.084",x:.45,y:.27,r:0},{path:"M41.286 5.24C31.346-1.987 23.23 1.895 22.64 15.773c-.23 5.407.69 9.012 4.661 12.775 2.71 2.567 4.086-.46 2.762-3.108C28.99 23.29 18.014 18.493 10 21.5-.5 25.44.425 40.745 7.103 44.084",x:.75,y:.4,r:85},{path:"M2 2c1.3 3.96 8.346 24.812 15.63 15.01 1.913-2.574 1.124-9.324-3.16-8.69-3.538.524-4.95 7.897-5.181 10.62-.542 6.372.877 13.801 5.356 18.61C23.46 47.013 42.616 42.798 51 35.18",x:.3,y:.6,r:0},{path:"M2 2c1.3 3.96 8.346 24.812 15.63 15.01 1.913-2.574 1.124-9.324-3.16-8.69-3.538.524-4.95 7.897-5.181 10.62-.542 6.372.877 13.801 5.356 18.61C23.46 47.013 42.616 42.798 51 35.18",x:.65,y:.25,r:-100}],et=0,it=[],nt=0;I.length<N;){var rt=st(0,1),at=st(0,1);.35<rt&&rt<.6&&.35<at&&at<.6||I.push({x:rt,y:at})}function st(t,e){return(Math.random()*(e-t)+t).toFixed(2)}function ot(t,e){var i=.5,n=.5,r=parseFloat(t.x),a=parseFloat(e.x),s=parseFloat(t.y),o=parseFloat(e.y);return(r-i)*(r-i)+(s-n)*(s-n)-((a-i)*(a-i)+(o-n)*(o-n))}function lt(t,e,i){var n="https://"+t.toLowerCase()+".wikipedia.org/w/api.php",r={action:"query",list:"recentchanges",rcnamespace:"0",rcprop:"title|flags|timestamp",rcstart:e,rcend:i,rctype:"edit",rcshow:"!bot",rclimit:B,format:"json"};return n+="?origin=*",Object.keys(r).forEach(function(t){n+="&"+t+"="+r[t]}),n}function ct(t){if(document.hasFocus()||t){var e=new Date,i=e.toISOString(),n=new Date(e.getTime()-36e5),r=n.toISOString();console.log(r,"\n",i,"\n",n.toLocaleTimeString()+" to "+e.toLocaleTimeString()),it=[],a.when(a.ajax(lt(h[0],i,r)),a.ajax(lt(h[1],i,r)),a.ajax(lt(h[2],i,r)),a.ajax(lt(h[3],i,r)),a.ajax(lt(h[4],i,r)),a.ajax(lt(h[5],i,r)),a.ajax(lt(h[6],i,r))).always(function(t,e,i,n,r,a,s){"success"===t[1]&&t[0].query.recentchanges.forEach(function(t){t.wiki=x[0],it.push(t)}),"success"===e[1]&&e[0].query.recentchanges.forEach(function(t){t.wiki=x[1],it.push(t)}),"success"===i[1]&&i[0].query.recentchanges.forEach(function(t){t.wiki=x[2],it.push(t)}),"success"===n[1]&&n[0].query.recentchanges.forEach(function(t){t.wiki=x[3],it.push(t)}),"success"===r[1]&&r[0].query.recentchanges.forEach(function(t){t.wiki=x[4],it.push(t)}),"success"===a[1]&&a[0].query.recentchanges.forEach(function(t){t.wiki=x[5],it.push(t)}),"success"===s[1]&&s[0].query.recentchanges.forEach(function(t){t.wiki=x[6],it.push(t)}),d3.shuffle(it),kt()})}else kt()}function dt(){var t=window.innerHeight-H.height(),e=m.width(),i=500<window.innerWidth?.6:.4;n.attr("height",t).attr("width",e).attr("viewBox","0 0 "+e+" "+t),s.range([Z,t-Z]),l.range([Z,e-Z]),o.selectAll("circle").style("opacity",0).attr("cx",function(t){return l(t.x)}).attr("cy",function(t){return s(t.y)}).transition().delay(function(t,e){return 10*e}).style("opacity",function(){return st(.1,.8)}),f.attr("transform","translate("+l(z[R].x)+", "+s(z[R].y)+")").style("opacity",1),d.selectAll("circle").attr("class","story-blob story-unread").style("opacity",0).style("visibility","hidden").attr("cx",function(t){return l(t.x)}).attr("cy",function(t){return s(t.y)}).on("mouseover",function(){var t=d3.select(this).attr("data-color");d3.select(this).transition().style("fill",t).attr("r",2*Z),f.transition().style("opacity",0).style("visibility","hidden")}).on("mouseleave",function(){var t=-1<d3.select(this).attr("class").indexOf("story-read")?d3.select(this).attr("data-color"):W;d3.select(this).transition().style("fill",t).attr("r",Z),f.transition().style("opacity",1).style("visibility","visible")}).on("click",ut),y.selectAll("line").attr("x1",function(t){return l(t.x)+U}).attr("x2",function(t){return l(t.x)+3*U}).attr("y1",function(t){return s(t.y)-2*U}).attr("y2",function(t){return s(t.y)-5*U}),y.selectAll("text").attr("x",function(t){return l(t.x)+3*U}).attr("y",function(t){return s(t.y)-5*U}).attr("dy","-5px"),q.find(".close").click(yt),b.keyup(function(t){"Escape"===t.key&&yt()}),u.attr("width",e),p.selectAll("path").attr("transform",function(t,e){return"translate("+l(tt[e].x)+", "+s(tt[e].y-.001)+") rotate("+tt[e].r+") scale("+i+")"}).attr("stroke-dasharray","500 500").attr("stroke-dashoffset",500).transition().duration(1400).attr("transform",function(t,e){return"translate("+l(tt[e].x)+", "+s(tt[e].y)+") rotate("+tt[e].r+") scale("+i+")"}).delay(function(t,e){return 10*N+200*e}).attr("stroke-dashoffset",0),r.call(c.transform,d3.zoomIdentity,d3.zoomTransform(r.node()).invert([e/2,t/2])),b.css("overflow","hidden auto")}function yt(){b.css("overflow","hidden auto"),bt(q),v.focus(),wt()}function ft(){G.hide(),a(G[nt]).show(),pt(nt),v.find(".story-nav .index").text(nt+1+"/"+Q),q.find(".story-content-container").scrollTop(0)}function ut(t,e){nt=e,ft(),b.css("overflow","hidden"),mt(q),pt(e),y.transition().style("opacity",0).style("visibility","hidden"),f.transition().style("opacity",0).style("visibility","hidden")}function pt(i){var t=d.selectAll("circle").filter(function(t,e){return e===i}),e=t.attr("data-color");t.style("fill",e).attr("class","story-blob story-read"),i===R&&(D=!1)}function ht(){var t="rgba"+O[et%O.length];0<it.length&&(F.text(i.label+" "+it[et].wiki),M.text(it[et].title),mt(j),j.find(".accent").css("border","1px solid "+t),o.selectAll("circle").sort(ot).filter(function(t,e){return e===et}).transition().duration(500).style("fill",t).style("opacity",1).attr("r",Z).transition().delay(1500).style("fill",W).style("opacity",st(.1,.9)).attr("r",U).on("end",function(){++et<it.length?ht():(et=0,ct())}))}function xt(){bt(j),o.selectAll("circle").filter(function(t,e){return e===et}).interrupt().style("fill",W).style("opacity",.5).attr("r",U)}function gt(){var t,e;return d3.select(".story-unread").each(function(){t=d3.select(this).attr("cx"),e=d3.select(this).attr("cy")}),[t,e]}function vt(){d.selectAll("circle").style("opacity",0).style("visibility","hidden").attr("r",U),y.style("opacity",0).style("visibility","hidden"),f.style("opacity",0).style("visibility","hidden"),o.style("opacity",1)}function wt(t,e,i){var n=function(t,e,i){return t<e+.1?X(t):i-.1<t?Y(t):1}(t,e,i);d.selectAll("circle").style("opacity",n).style("visibility","visible").attr("r",Z),D?(y.style("opacity",n).style("filter","blur("+2*(1-n)+"px)").style("visibility","visible"),f.style("opacity",n).style("visibility","visible")):f.style("opacity",n).style("visibility","visible").attr("transform","translate("+gt()[0]+", "+gt()[1]+")"),o.style("opacity",Math.max(.1,1-n))}function bt(t){t.removeClass("visible").addClass("hidden")}function mt(t){t.removeClass("hidden").addClass("visible")}function kt(){v.show();var t=a(window).scrollTop(),e=Math.min($-t/L/4,$),i=((t-(w.offset().top-window.innerHeight))/window.innerHeight).toFixed(2),n=t/(w.offset().top-window.innerHeight);r.call(c.scaleTo,e),n<J?(mt(k),bt(A),bt(C),bt(E),vt(),p.style("visibility","visible"),xt()):n<K?(bt(k),mt(A),bt(C),bt(E),vt(),p.style("visibility","visible"),xt()):n<P?(bt(k),bt(A),mt(C),bt(E),wt(n,K,P),p.style("visibility","hidden"),xt()):n<V?(bt(k),bt(A),bt(C),mt(E),vt(),p.style("visibility","hidden"),ht()):V<=n&&(bt(k),bt(A),bt(C),bt(E),vt(),p.style("visibility","hidden"),xt(),v.css("opacity",Math.max(0,1-i)))}function At(){var t=d3.event.transform;r.attr("transform","translate("+t.x+","+t.y+") scale("+t.k+")")}a(window).scroll(function(){a(window).scrollTop()>=w.offset().top?v.hide():requestAnimationFrame(kt)}),a(window).resize(function(){S===m.width()&&T===window.innerHeight||(S=m.width(),T=window.innerHeight,requestAnimationFrame(function(){dt(),ht(),kt()}))}),t=2*L,e.css("height",t/window.innerHeight*100+"vh"),w.css({position:"relative","background-color":"#ffffff","padding-top":"2.5rem","padding-bottom":"0.5rem"}),function(t){a(".header-main").hide(),n=d3.select(g).append("svg"),r=n.append("g").attr("transform-origin","0 0 0"),s=d3.scaleLinear().domain([0,d3.max(I,function(t){return t.y})]),l=d3.scaleLinear().domain([0,1]),(o=r.append("g").attr("class","blobs-g")).selectAll("circle").data(I).enter().append("circle").attr("class",function(t){return t.x+" "+t.y}).style("fill",W).attr("r",U);var e=n.append("defs").append("linearGradient").attr("id","mainGradient").attr("gradientTransform","rotate(90)");e.append("stop").attr("class","stop-0").attr("offset","0"),e.append("stop").attr("class","stop-1").attr("offset","1"),u=n.append("rect").classed("filled",!0).attr("x",0).attr("y",0).attr("width",S).attr("height",2*Z),(y=r.append("g").attr("class","click-cue")).selectAll("line").data([z[R]]).enter().append("line"),y.selectAll("text").data([z[R]]).enter().append("text").text(i.click).attr("text-anchor","start"),y.style("opacity",0).style("visibility","hidden"),(f=r.append("g").attr("class","pulse-g").style("opacity",0)).append("circle").attr("class","pulse").attr("cx","0%").attr("cy","0%").attr("r",Z).style("opacity",0),(d=r.append("g").attr("class","story-blobs")).selectAll("circle").data(z.slice(0,Q)).enter().append("circle").attr("title",function(t,e){return"Story "+(e+1)}).attr("data-color",function(t,e){return O[e]?"rgba"+O[e]:W}).style("fill",W).style("stroke-width",_).style("stroke","rgba(255, 255, 255, 0)").attr("r",U),G.each(function(t){a(this).find(".story-image").css("border","4px solid rgba"+O[t])}),(p=r.append("g").attr("class","ornaments-g")).selectAll("path").data(tt).enter().append("path").attr("class","ornament").attr("d",function(t){return t.path}).style("stroke-width",3).style("stroke",W).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round"),v.find(".next-story").click(function(){nt<Q-1?nt++:nt=0,ft()}),v.find(".prev-story").click(function(){0<nt?nt--:nt=Q-1,ft()}),c=d3.zoom().scaleExtent([1,2]).duration(0).on("zoom",At),t()}(kt),dt(),ct(!0)});